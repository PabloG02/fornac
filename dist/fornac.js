(function(me,S){typeof exports=="object"&&typeof module<"u"?S(exports,require("d3")):typeof define=="function"&&define.amd?define(["exports","d3"],S):(me=typeof globalThis<"u"?globalThis:me||self,S(me.fornac={},me.d3))})(this,(function(me,S){"use strict";const U={nodeStrokeWidth:"0.8",directionArrowSize:"6",directionArrowWidth:"0.7",node:"fornac-module-node",directionArrow:"fornac-module-directionArrow",plot:"fornac-module-plot",selectedNode:"fornac-module-selectedNode",nodeLabel:"fornac-module-nodeLabel",link:"fornac-module-link",plotLabel:"fornac-module-plotLabel",transparent:"fornac-module-transparent",dragLine:"fornac-module-dragLine",mouseEventHelper:"fornac-module-mouseEventHelper"};function gt(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}function ht(s){if(Object.prototype.hasOwnProperty.call(s,"__esModule"))return s;var n=s.default;if(typeof n=="function"){var e=function o(){return this instanceof o?Reflect.construct(n,arguments,this.constructor):n.apply(this,arguments)};e.prototype=n.prototype}else e={};return Object.defineProperty(e,"__esModule",{value:!0}),Object.keys(s).forEach(function(o){var t=Object.getOwnPropertyDescriptor(s,o);Object.defineProperty(e,o,t.get?t:{enumerable:!0,get:function(){return s[o]}})}),e}var Se={},Be,pt=new Uint8Array(16);function et(){if(!Be&&(Be=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!Be))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Be(pt)}const mt=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function qe(s){return typeof s=="string"&&mt.test(s)}for(var te=[],Ge=0;Ge<256;++Ge)te.push((Ge+256).toString(16).substr(1));function De(s){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,e=(te[s[n+0]]+te[s[n+1]]+te[s[n+2]]+te[s[n+3]]+"-"+te[s[n+4]]+te[s[n+5]]+"-"+te[s[n+6]]+te[s[n+7]]+"-"+te[s[n+8]]+te[s[n+9]]+"-"+te[s[n+10]]+te[s[n+11]]+te[s[n+12]]+te[s[n+13]]+te[s[n+14]]+te[s[n+15]]).toLowerCase();if(!qe(e))throw TypeError("Stringified UUID is invalid");return e}var tt,Je,Ze=0,Qe=0;function vt(s,n,e){var o=n&&e||0,t=n||new Array(16);s=s||{};var a=s.node||tt,i=s.clockseq!==void 0?s.clockseq:Je;if(a==null||i==null){var u=s.random||(s.rng||et)();a==null&&(a=tt=[u[0]|1,u[1],u[2],u[3],u[4],u[5]]),i==null&&(i=Je=(u[6]<<8|u[7])&16383)}var c=s.msecs!==void 0?s.msecs:Date.now(),p=s.nsecs!==void 0?s.nsecs:Qe+1,g=c-Ze+(p-Qe)/1e4;if(g<0&&s.clockseq===void 0&&(i=i+1&16383),(g<0||c>Ze)&&s.nsecs===void 0&&(p=0),p>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");Ze=c,Qe=p,Je=i,c+=122192928e5;var m=((c&268435455)*1e4+p)%4294967296;t[o++]=m>>>24&255,t[o++]=m>>>16&255,t[o++]=m>>>8&255,t[o++]=m&255;var b=c/4294967296*1e4&268435455;t[o++]=b>>>8&255,t[o++]=b&255,t[o++]=b>>>24&15|16,t[o++]=b>>>16&255,t[o++]=i>>>8|128,t[o++]=i&255;for(var k=0;k<6;++k)t[o+k]=a[k];return n||De(t)}function nt(s){if(!qe(s))throw TypeError("Invalid UUID");var n,e=new Uint8Array(16);return e[0]=(n=parseInt(s.slice(0,8),16))>>>24,e[1]=n>>>16&255,e[2]=n>>>8&255,e[3]=n&255,e[4]=(n=parseInt(s.slice(9,13),16))>>>8,e[5]=n&255,e[6]=(n=parseInt(s.slice(14,18),16))>>>8,e[7]=n&255,e[8]=(n=parseInt(s.slice(19,23),16))>>>8,e[9]=n&255,e[10]=(n=parseInt(s.slice(24,36),16))/1099511627776&255,e[11]=n/4294967296&255,e[12]=n>>>24&255,e[13]=n>>>16&255,e[14]=n>>>8&255,e[15]=n&255,e}function yt(s){s=unescape(encodeURIComponent(s));for(var n=[],e=0;e<s.length;++e)n.push(s.charCodeAt(e));return n}var bt="6ba7b810-9dad-11d1-80b4-00c04fd430c8",kt="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function rt(s,n,e){function o(t,a,i,u){if(typeof t=="string"&&(t=yt(t)),typeof a=="string"&&(a=nt(a)),a.length!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var c=new Uint8Array(16+t.length);if(c.set(a),c.set(t,a.length),c=e(c),c[6]=c[6]&15|n,c[8]=c[8]&63|128,i){u=u||0;for(var p=0;p<16;++p)i[u+p]=c[p];return i}return De(c)}try{o.name=s}catch{}return o.DNS=bt,o.URL=kt,o}function xt(s){if(typeof s=="string"){var n=unescape(encodeURIComponent(s));s=new Uint8Array(n.length);for(var e=0;e<n.length;++e)s[e]=n.charCodeAt(e)}return wt(Nt(At(s),s.length*8))}function wt(s){for(var n=[],e=s.length*32,o="0123456789abcdef",t=0;t<e;t+=8){var a=s[t>>5]>>>t%32&255,i=parseInt(o.charAt(a>>>4&15)+o.charAt(a&15),16);n.push(i)}return n}function ot(s){return(s+64>>>9<<4)+14+1}function Nt(s,n){s[n>>5]|=128<<n%32,s[ot(n)-1]=n;for(var e=1732584193,o=-271733879,t=-1732584194,a=271733878,i=0;i<s.length;i+=16){var u=e,c=o,p=t,g=a;e=oe(e,o,t,a,s[i],7,-680876936),a=oe(a,e,o,t,s[i+1],12,-389564586),t=oe(t,a,e,o,s[i+2],17,606105819),o=oe(o,t,a,e,s[i+3],22,-1044525330),e=oe(e,o,t,a,s[i+4],7,-176418897),a=oe(a,e,o,t,s[i+5],12,1200080426),t=oe(t,a,e,o,s[i+6],17,-1473231341),o=oe(o,t,a,e,s[i+7],22,-45705983),e=oe(e,o,t,a,s[i+8],7,1770035416),a=oe(a,e,o,t,s[i+9],12,-1958414417),t=oe(t,a,e,o,s[i+10],17,-42063),o=oe(o,t,a,e,s[i+11],22,-1990404162),e=oe(e,o,t,a,s[i+12],7,1804603682),a=oe(a,e,o,t,s[i+13],12,-40341101),t=oe(t,a,e,o,s[i+14],17,-1502002290),o=oe(o,t,a,e,s[i+15],22,1236535329),e=se(e,o,t,a,s[i+1],5,-165796510),a=se(a,e,o,t,s[i+6],9,-1069501632),t=se(t,a,e,o,s[i+11],14,643717713),o=se(o,t,a,e,s[i],20,-373897302),e=se(e,o,t,a,s[i+5],5,-701558691),a=se(a,e,o,t,s[i+10],9,38016083),t=se(t,a,e,o,s[i+15],14,-660478335),o=se(o,t,a,e,s[i+4],20,-405537848),e=se(e,o,t,a,s[i+9],5,568446438),a=se(a,e,o,t,s[i+14],9,-1019803690),t=se(t,a,e,o,s[i+3],14,-187363961),o=se(o,t,a,e,s[i+8],20,1163531501),e=se(e,o,t,a,s[i+13],5,-1444681467),a=se(a,e,o,t,s[i+2],9,-51403784),t=se(t,a,e,o,s[i+7],14,1735328473),o=se(o,t,a,e,s[i+12],20,-1926607734),e=ie(e,o,t,a,s[i+5],4,-378558),a=ie(a,e,o,t,s[i+8],11,-2022574463),t=ie(t,a,e,o,s[i+11],16,1839030562),o=ie(o,t,a,e,s[i+14],23,-35309556),e=ie(e,o,t,a,s[i+1],4,-1530992060),a=ie(a,e,o,t,s[i+4],11,1272893353),t=ie(t,a,e,o,s[i+7],16,-155497632),o=ie(o,t,a,e,s[i+10],23,-1094730640),e=ie(e,o,t,a,s[i+13],4,681279174),a=ie(a,e,o,t,s[i],11,-358537222),t=ie(t,a,e,o,s[i+3],16,-722521979),o=ie(o,t,a,e,s[i+6],23,76029189),e=ie(e,o,t,a,s[i+9],4,-640364487),a=ie(a,e,o,t,s[i+12],11,-421815835),t=ie(t,a,e,o,s[i+15],16,530742520),o=ie(o,t,a,e,s[i+2],23,-995338651),e=ae(e,o,t,a,s[i],6,-198630844),a=ae(a,e,o,t,s[i+7],10,1126891415),t=ae(t,a,e,o,s[i+14],15,-1416354905),o=ae(o,t,a,e,s[i+5],21,-57434055),e=ae(e,o,t,a,s[i+12],6,1700485571),a=ae(a,e,o,t,s[i+3],10,-1894986606),t=ae(t,a,e,o,s[i+10],15,-1051523),o=ae(o,t,a,e,s[i+1],21,-2054922799),e=ae(e,o,t,a,s[i+8],6,1873313359),a=ae(a,e,o,t,s[i+15],10,-30611744),t=ae(t,a,e,o,s[i+6],15,-1560198380),o=ae(o,t,a,e,s[i+13],21,1309151649),e=ae(e,o,t,a,s[i+4],6,-145523070),a=ae(a,e,o,t,s[i+11],10,-1120210379),t=ae(t,a,e,o,s[i+2],15,718787259),o=ae(o,t,a,e,s[i+9],21,-343485551),e=Le(e,u),o=Le(o,c),t=Le(t,p),a=Le(a,g)}return[e,o,t,a]}function At(s){if(s.length===0)return[];for(var n=s.length*8,e=new Uint32Array(ot(n)),o=0;o<n;o+=8)e[o>>5]|=(s[o/8]&255)<<o%32;return e}function Le(s,n){var e=(s&65535)+(n&65535),o=(s>>16)+(n>>16)+(e>>16);return o<<16|e&65535}function Lt(s,n){return s<<n|s>>>32-n}function Fe(s,n,e,o,t,a){return Le(Lt(Le(Le(n,s),Le(o,a)),t),e)}function oe(s,n,e,o,t,a,i){return Fe(n&e|~n&o,s,n,t,a,i)}function se(s,n,e,o,t,a,i){return Fe(n&o|e&~o,s,n,t,a,i)}function ie(s,n,e,o,t,a,i){return Fe(n^e^o,s,n,t,a,i)}function ae(s,n,e,o,t,a,i){return Fe(e^(n|~o),s,n,t,a,i)}var Mt=rt("v3",48,xt);function Et(s,n,e){s=s||{};var o=s.random||(s.rng||et)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,n){e=e||0;for(var t=0;t<16;++t)n[e+t]=o[t];return n}return De(o)}function Tt(s,n,e,o){switch(s){case 0:return n&e^~n&o;case 1:return n^e^o;case 2:return n&e^n&o^e&o;case 3:return n^e^o}}function Ke(s,n){return s<<n|s>>>32-n}function _t(s){var n=[1518500249,1859775393,2400959708,3395469782],e=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof s=="string"){var o=unescape(encodeURIComponent(s));s=[];for(var t=0;t<o.length;++t)s.push(o.charCodeAt(t))}else Array.isArray(s)||(s=Array.prototype.slice.call(s));s.push(128);for(var a=s.length/4+2,i=Math.ceil(a/16),u=new Array(i),c=0;c<i;++c){for(var p=new Uint32Array(16),g=0;g<16;++g)p[g]=s[c*64+g*4]<<24|s[c*64+g*4+1]<<16|s[c*64+g*4+2]<<8|s[c*64+g*4+3];u[c]=p}u[i-1][14]=(s.length-1)*8/Math.pow(2,32),u[i-1][14]=Math.floor(u[i-1][14]),u[i-1][15]=(s.length-1)*8&4294967295;for(var m=0;m<i;++m){for(var b=new Uint32Array(80),k=0;k<16;++k)b[k]=u[m][k];for(var N=16;N<80;++N)b[N]=Ke(b[N-3]^b[N-8]^b[N-14]^b[N-16],1);for(var x=e[0],L=e[1],M=e[2],T=e[3],v=e[4],_=0;_<80;++_){var I=Math.floor(_/20),z=Ke(x,5)+Tt(I,L,M,T)+v+n[I]+b[_]>>>0;v=T,T=M,M=Ke(L,30)>>>0,L=x,x=z}e[0]=e[0]+x>>>0,e[1]=e[1]+L>>>0,e[2]=e[2]+M>>>0,e[3]=e[3]+T>>>0,e[4]=e[4]+v>>>0}return[e[0]>>24&255,e[0]>>16&255,e[0]>>8&255,e[0]&255,e[1]>>24&255,e[1]>>16&255,e[1]>>8&255,e[1]&255,e[2]>>24&255,e[2]>>16&255,e[2]>>8&255,e[2]&255,e[3]>>24&255,e[3]>>16&255,e[3]>>8&255,e[3]&255,e[4]>>24&255,e[4]>>16&255,e[4]>>8&255,e[4]&255]}var St=rt("v5",80,_t);const Pt="00000000-0000-0000-0000-000000000000";function Ct(s){if(!qe(s))throw TypeError("Invalid UUID");return parseInt(s.substr(14,1),16)}const Rt=ht(Object.freeze(Object.defineProperty({__proto__:null,NIL:Pt,parse:nt,stringify:De,v1:vt,v3:Mt,v4:Et,v5:St,validate:qe,version:Ct},Symbol.toStringTag,{value:"Module"})));var st;function It(){if(st)return Se;st=1;var s=Rt,n=typeof Buffer<"u"?o=>Buffer.from(o).toString("base64"):o=>btoa(String.fromCharCode(...o)),e=typeof Buffer<"u"?o=>Buffer.from(o,"base64"):o=>Uint8Array.from(atob(o),t=>t.charCodeAt(0));return Se.encode=function(o){var t=s.parse(o),a=n(t),i=a.replace(/\+/g,"-").replace(/\//g,"_").substring(0,22);return i},Se.decode=function(o){var t=o.replace(/-/g,"+").replace(/_/g,"/")+"==";return s.stringify(e(t))},Se.v4=function(){var o=s.v4(null,new Uint8Array(16)),t=n(o),a=t.replace(/\+/g,"-").replace(/\//g,"_").substring(0,22);return a},Se.nice=function(){var o=s.v4(null,new Uint8Array(16));o[0]=o[0]&127;var t=n(o),a=t.replace(/\+/g,"-").replace(/\//g,"_").substring(0,22);return a},Se}var je,it;function Xt(){return it||(it=1,je=It()),je}var Yt=Xt();const K=gt(Yt),Ot="data:image/svg+xml,%3c?xml%20version='1.0'%20encoding='utf-8'?%3e%3c!--%20Generated%20by%20IcoMoon.io%20--%3e%3c!DOCTYPE%20svg%20PUBLIC%20'-//W3C//DTD%20SVG%201.1//EN'%20'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3e%3csvg%20version='1.1'%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='512'%20height='512'%20viewBox='0%200%20512%20512'%3e%3cg%20id='icomoon-ignore'%3e%3c/g%3e%3cpath%20d='M96%2064l320%20192-320%20192z'%3e%3c/path%3e%3c/svg%3e";function Ie(s,n){let e=!1,o=K.nice(),t=null,a="right",i=null,u=null;var c,p;return typeof n=="function"?c=n:(n=n||{},c=n.onOpen,p=n.onClose),"rootElement"in n&&(t=n.rootElement),"pos"in n&&(i=n.pos),"orientation"in n&&(a=n.orientation),"parentStart"in n&&(u=n.parentStart),S.selectAll(".d3-context-menu-"+o).data([1]).enter().append("div").classed("d3-context-menu",!0).classed("d3-context-menu-"+o,!0),S.select("body").on("click.d3-context-menu-"+o,function(){if(e){e=!1;return}console.log("body click close"),S.select(".d3-context-menu-"+o).style("display","none"),a="right",p&&p()}),function(g,m,b=!1,k=function(){}){var N=this;let x=null,L=this;t==null?x=S.mouse(this):x=S.mouse(t);let M=null;e=b,S.selectAll(".d3-context-menu-"+o).html("");var T=S.selectAll(".d3-context-menu-"+o).on("contextmenu",function(I){console.log("context-menu close"),S.select(".d3-context-menu-"+o).style("display","none"),a="right",S.event.preventDefault(),S.event.stopPropagation()}).append("ul");if(T.selectAll("li").data(typeof s=="function"?s(g):s).enter().append("li").attr("class",function(I){console.log("d:",I);var z="";return I.divider&&(z+=" is-divider"),I.disabled&&(z+=" is-disabled"),I.action||(z+=" is-header"),"children"in I&&(z+=" d3-context-menu-recursive"),z}).html(function(I){return I.divider?"<hr>":(I.title||console.error("No title attribute set. Check the spelling of your options."),typeof I.title=="string"?I.title:I.title(g))}).on("click",function(I,z){I.disabled||I.action&&(I.action(N,g,m,x),console.log("click close"),S.selectAll(".d3-context-menu").style("display","none"),a="right",p&&p())}).on("mouseenter",function(I,z){if(S.select(this).classed("d3-context-menu-selected",!0),M!=null){if(S.select(".d3-context-menu-"+o).selectAll("li").classed("d3-context-menu-selected",!1),typeof I.children>"u"){console.log("no children close"),S.select(".d3-context-menu-"+M).style("display","none"),M=null;return}if(I.childUid==M)return;console.log("open different child menu close"),S.select(".d3-context-menu-"+M).style("display","none"),M=null}if(typeof I.children<"u"){let B=this.getBoundingClientRect(),X=null;a=="left"?X=Ie(I.children,{rootElement:L,pos:[B.left+window.pageXOffset,B.top-2+window.pageYOffset],orientation:"left"}):X=Ie(I.children,{pos:[B.left+B.width+window.pageXOffset,B.top-2+window.pageYOffset],rootElement:L,parentStart:[B.left+window.pageXOffset,B.top-2+window.pageYOffset]}),I.childUid=X.apply(this,[g,z,!0,function(){}]),M=I.childUid}S.select(this).classed("d3-context-menu-selected",!0)}).on("mouseleave",function(I,z){M==null&&S.select(this).classed("d3-context-menu-selected",!1)}),T.selectAll(".d3-context-menu-recursive").append("img").attr("src",Ot).attr("width","14px").attr("height","14px").style("position","absolute").style("right","5px"),c&&c(g,m)===!1)return o;let v=S.select(".d3-context-menu-"+o).style("display","block");i==null?S.select(".d3-context-menu-"+o).style("left",S.event.pageX-2+"px").style("top",S.event.pageY-2+"px"):S.select(".d3-context-menu-"+o).style("left",i[0]+"px").style("top",i[1]+"px");let _=v.node().getBoundingClientRect();return(_.left+_.width>window.innerWidth||a=="left")&&(a="left",i==null?S.select(".d3-context-menu-"+o).style("left",S.event.pageX-2-_.width+"px").style("top",S.event.pageY-2+"px"):u!=null?S.select(".d3-context-menu-"+o).style("left",u[0]-_.width+"px").style("top",u[1]+"px"):S.select(".d3-context-menu-"+o).style("left",i[0]-_.width+"px").style("top",i[1]+"px")),e||(S.event.preventDefault(),S.event.stopPropagation()),o}}var Me=function(s,n){return s-n};function Ut(s,n){if(s===n)return!0;if(s===null||n===null||s.length!=n.length)return!1;for(var e=0;e<s.length;++e)if(s[e]!==n[e])return!1;return!0}function at(){var s=this;s.bracketLeft="([{<ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),s.bracketRight=")]}>abcdefghijklmnopqrstuvwxyz".split(""),s.inverseBrackets=function(n){for(var e={},o=0;o<n.length;o++)e[n[o]]=o;return e},s.maximumMatching=function(e){for(var o=e[0],t=0,a=new Array(o+1),i=0;i<=o;i++){a[i]=new Array(o+1);for(var u=i;u<=o;u++)a[i][u]=0}for(var c=0,i=o-t-1;i>0;i--)for(var u=i+t+1;u<=o;u++){c=a[i][u-1];for(var p=u-t-1;p>=i;p--)e[p]===u&&(c=Math.max(c,(p>i?a[i][p-1]:0)+1+(u-p-1>0?a[p+1][u-1]:0)));a[i][u]=c}return c=a[1][o],a},s.backtrackMaximumMatching=function(n,e){var o=Array.apply(null,Array(n.length)).map(function(){return 0});return s.mmBt(n,o,e,1,n.length-1),o},s.mmBt=function(n,e,o,t,a){var i=n[t][a],u=0;if(!(a-t-1<u)){if(n[t][a-1]==i){s.mmBt(n,e,o,t,a-1);return}for(var c=a-u-1;c>=t;c--)if(o[a]===c){var p=c>t?n[t][c-1]:0,g=a-c-1>0?n[c+1][a-1]:0;if(p+g+1==i){e[c]=a,e[a]=c,t<c&&s.mmBt(n,e,o,t,c-1),s.mmBt(n,e,o,c+1,a-1);return}}console.log("FAILED!!!"+t+","+a+": backtracking failed!")}},s.dotbracketToPairtable=function(n){var e=Array.apply(null,new Array(n.length+1)).map(Number.prototype.valueOf,0);e[0]=n.length;for(var o={},t=0;t<s.bracketLeft.length;t++)o[t]=[];for(var a=s.inverseBrackets(s.bracketLeft),i=s.inverseBrackets(s.bracketRight),t=0;t<n.length;t++){var u=n[t],c=t+1;if(u=="."||u=="o")e[c]=0;else if(u in a)o[a[u]].push(c);else if(u in i){var p=o[i[u]].pop();e[c]=p,e[p]=c}else throw"Unknown symbol in dotbracket string"}for(var g in o)if(o[g].length>0)throw"Unmatched base at position "+o[g][0];return e},s.insertIntoStack=function(n,e,o){for(var t=0;n[t].length>0&&n[t][n[t].length-1]<o;)t+=1;return n[t].push(o),t},s.deleteFromStack=function(n,e){for(var o=0;n[o].length===0||n[o][n[o].length-1]!=e;)o+=1;return n[o].pop(),o},s.pairtableToDotbracket=function(n){for(var e={},a=0;a<n[0];a++)e[a]=[];for(var o={},t="",a,a=1;a<n[0]+1;a++){if(n[a]!==0&&n[a]in o)throw"Invalid pairtable contains duplicate entries";o[n[a]]=!0,n[a]===0?t+=".":n[a]>a?t+=s.bracketLeft[s.insertIntoStack(e,a,n[a])]:t+=s.bracketRight[s.deleteFromStack(e,a)]}return t},s.findUnmatched=function(n,e,o){for(var t=[],a=[],i=e,u=o,c,c=e;c<=o;c++)n[c]!==0&&(n[c]<e||n[c]>o)&&a.push([c,n[c]]);for(var c=i;c<=u;c++){for(;n[c]===0&&c<=u;)c++;for(o=n[c];n[c]===o;)c++,o--;t=t.concat(s.findUnmatched(n,c,o))}return a.length>0&&t.push(a),t},s.removePseudoknotsFromPairtable=function(n){for(var e=s.maximumMatching(n),o=s.backtrackMaximumMatching(e,n),t=[],a=1;a<n.length;a++)n[a]<a||o[a]!=n[a]&&(t.push([a,n[a]]),n[n[a]]=0,n[a]=0);return t},s.ptToElements=function(n,e,o,t,a){var i=[],u=[o-1],c=[t+1];if(arguments.length<5&&(a=[]),o>t)return[];for(;n[o]===0;o++)u.push(o);for(;n[t]===0;t--)c.push(t);if(o>t){if(u.push(o),e===0)return[["e",e,u.sort(Me)]];for(var p=!1,g=[],m=[],b=0;b<u.length;b++)p?m.push(u[b]):g.push(u[b]),a.indexOf(u[b])>=0&&(p=!0);return p?[["h",e,u.sort(Me)]]:[["h",e,u.sort(Me)]]}if(n[o]!=t){var k=u,b=o;for(k.push(b);b<=t;){for(i=i.concat(s.ptToElements(n,e,b,n[b],a)),k.push(n[b]),b=n[b]+1;n[b]===0&&b<=t;b++)k.push(b);k.push(b)}return k.pop(),k=k.concat(c),k.length>0&&(e===0?i.push(["e",e,k.sort(Me)]):i.push(["m",e,k.sort(Me)])),i}if(n[o]===t){u.push(o),c.push(t);var N=u.concat(c);N.length>4&&(e===0?i.push(["e",e,u.concat(c).sort(Me)]):i.push(["i",e,u.concat(c).sort(Me)]))}for(var x=[];n[o]===t&&o<t;)x.push(o),x.push(t),o+=1,t-=1,e+=1;return u=[o-1],c=[t+1],i.push(["s",e,x.sort(Me)]),i.concat(s.ptToElements(n,e,o,t,a))}}var we=new at;function lt(s){var n=this;return n.colorsText=s,n.parseRange=function(e){for(var o=e.split(","),t=[],a=0;a<o.length;a++){var i=o[a].split("-");if(i.length==1)t.push(parseInt(i[0]));else if(i.length==2)for(var u=parseInt(i[0]),c=parseInt(i[1]),p=u;p<=c;p++)t.push(p);else console.log("Malformed range (too many dashes):",e)}return t},n.parseColorText=function(e){for(var o=e.split(`
`),t="",a=1,i={colorValues:{"":{}},range:["white","steelblue"]},u=[],c=0;c<o.length;c++){if(o[c][0]==">"){t=o[c].trim().slice(1),a=1,i.colorValues[t]={};continue}let m=o[c].trim().split(/[\s]+/);for(var p=0;p<m.length;p++)if(isNaN(m[p])){if(m[p].search("range")===0){let L=m[p].split("=")[1].split(":");i.range=[L[0],L[1]];continue}if(m[p].search("domain")==0){let L=m[p].split("=")[1].split(":");i.domain=[L[0],L[1]];continue}let b=m[p].split(":"),k=n.parseRange(b[0]),N=b[1];for(var g=0;g<k.length;g++)isNaN(N)?i.colorValues[t][k[g]]=N:(i.colorValues[t][k[g]]=+N,u.push(Number(N)))}else i.colorValues[t][a]=Number(m[p]),a+=1,u.push(Number(m[p]))}return"domain"in i||(i.domain=[Math.min.apply(null,u),Math.max.apply(null,u)]),n.colorsJson=i,n},n.normalizeColors=function(){var e;for(var o in n.colorsJson){var t=Number.MAX_VALUE,a=Number.MIN_VALUE;for(var i in n.colorsJson.colorValues[o])e=n.colorsJson.colorValues[o][i],typeof e=="number"&&(e<t&&(t=e),e>a&&(a=e));for(i in n.colorsJson.colorValues[o])e=n.colorsJson.colorValues[o][i],typeof e=="number"&&(n.colorsJson.colorValues[o][i]=(e-t)/(a-t))}return n},n.parseColorText(n.colorsText),n}var Ne=function(s,n){return s-n};typeof String.prototype.trim>"u"&&(String.prototype.trim=function(){return String(this).replace(/^\s+|\s+$/g,"")});function ze(s="",n="",e="",o=1){var t=this;t.type="rna",t.circularizeExternal=!1,t.seq=s,t.dotbracket=n,t.structName=e,t.circular=!1,t.dotbracket.slice(-1)=="*"&&(t.dotbracket=t.dotbracket.slice(0,-1),t.circular=!0),t.uid=K.nice(),t.elements=[],t.pseudoknotPairs=[],t.nucsToNodes={},t.addUids=function(i){let u=t.nodes.filter(function(c){return c.nodeType=="nucleotide"});for(let c=0;c<i.length&&c<u.length;c++)u[c].uid=i[c];return t},t.computePairtable=function(){t.pairtable=we.dotbracketToPairtable(t.dotbracket)},t.removeBreaks=function(i){for(var u=[],c=-1;(c=i.indexOf("&"))>=0;)u.push(c),i=i.substring(0,c)+i.substring(c+1,i.length);return{targetString:i,breaks:u}};var a=t.removeBreaks(t.dotbracket);t.dotbracket=a.targetString,t.dotBracketBreaks=a.breaks,a=t.removeBreaks(t.seq),t.seq=a.targetString,t.seqBreaks=a.breaks,t.rnaLength=t.dotbracket.length,Ut(t.dotBracketBreaks,t.seqBreaks)||(console.log("WARNING: Sequence and structure breaks not equal"),console.log("WARNING: Using the breaks in the structure")),t.computePairtable(),t.addPositions=function(i,u){let c=t.nodes.filter(function(p){return p.nodeType==i});for(let p=0;p<c.length;p++)c[p].x=u[p][0],c[p].y=u[p][1];return t},t.breakNodesToFakeNodes=function(){let i=t.nodes.filter(function(c){return c.nodeType=="nucleotide"});for(let c=0;c<i.length;c++)t.dotBracketBreaks.indexOf(c)>=0&&(i[c].nodeType="middle",i[c+1].nodeType="middle");for(let c=0;c<t.elements.length;c++){var u=!1;for(let p=0;p<t.elements[c][2].length;p++)t.dotBracketBreaks.indexOf(t.elements[c][2][p])>=0&&(u=!0);u?t.elements[c][2].map(function(p){p!=0&&(t.nodes[p-1].elemType="e")}):t.elements[c][2].map(function(p){p!=0&&(t.nodes[p-1].elemType=t.elements[c][0])})}return t},t.getPositions=function(i){var u=[];let c=t.nodes.filter(function(p){return p.nodeType==i});for(let p=0;p<c.length;p++)u.push([c[p].x,c[p].y]);return u},t.getUids=function(){var i=[];for(let u=0;u<t.dotbracket.length;u++)i.push(t.nodes[u].uid);return i},t.reinforceStems=function(){var i=t.pairtable;let u=t.elements.filter(function(c){return c[0]=="s"&&c[2].length>=4});for(let c=0;c<u.length;c++){let p=u[c][2],g=p.slice(0,p.length/2);for(let m=0;m<g.length-1;m++)t.addFakeNode([g[m],g[m+1],i[g[m+1]],i[g[m]]])}return t},t.reinforceLoops=function(){var i=function(g){return g!==0&&g<=t.dotbracket.length};for(let g=0;g<t.elements.length;g++)if(!(t.elements[g][0]=="s"||!t.circularizeExternal&&t.elements[g][0]=="e")){var u=t.elements[g][2].filter(i);if(t.elements[g][0]=="e"){var c={name:"",num:-3,radius:0,rna:t,nodeType:"middle",elemType:"f",nucs:[],x:t.nodes[t.rnaLength-1].x,y:t.nodes[t.rnaLength-1].y,px:t.nodes[t.rnaLength-1].px,py:t.nodes[t.rnaLength-1].py,uid:K.nice()},p={name:"",num:-2,radius:0,rna:t,nodeType:"middle",elemType:"f",nucs:[],x:t.nodes[0].x,y:t.nodes[0].y,px:t.nodes[0].px,py:t.nodes[0].py,uid:K.nice()};u.push(t.nodes.length+1),u.push(t.nodes.length+2),t.nodes.push(c),t.nodes.push(p)}t.addFakeNode(u)}return t},t.updateLinkUids=function(){for(let i=0;i<t.links.length;i++)t.links[i].uid=t.links[i].source.uid+t.links[i].target.uid;return t},t.addFakeNode=function(i){var u=18,c=3.1415*2/(2*i.length),p=u/(2*Math.tan(c)),g="";for(let T=0;T<i.length;T++)g+=t.nodes[i[T]-1].uid;var m={name:"",num:-1,radius:p,rna:t,nodeType:"middle",elemType:"f",nucs:i,uid:g};t.nodes.push(m);var b=0,k=0,N=0;c=(i.length-2)*3.14159/(2*i.length),p=.5/Math.cos(c);for(let T=0;T<i.length;T++)if(!(i[T]===0||i[T]>t.dotbracket.length)){t.links.push({source:t.nodes[i[T]-1],target:t.nodes[t.nodes.length-1],linkType:"fake",value:p,uid:K.nice()}),i.length>4&&t.links.push({source:t.nodes[i[T]-1],target:t.nodes[i[(T+Math.floor(i.length/2))%i.length]-1],linkType:"fake",value:p*2,uid:K.nice()});var x=(i.length-2)*3.14159/i.length,L=2*Math.cos(3.14159/2-x/2);t.links.push({source:t.nodes[i[T]-1],target:t.nodes[i[(T+2)%i.length]-1],linkType:"fake",value:L});var M=t.nodes[i[T]-1];"x"in M&&(b+=M.x,k+=M.y,N+=1)}return N>0&&(m.x=b/N,m.y=k/N,m.px=m.x,m.py=m.y),t},t.connectFakeNodes=function(){for(var i=18,u=function(M){return M.nodeType=="middle"},c={},p=t.nodes.filter(u),g={},m=1;m<=t.nodes.length;m++)c[m]=[];for(var m=0;m<p.length;m++)for(var b=p[m],k=0;k<b.nucs.length;k++){for(var N=b.nucs[k],x=0;x<c[N].length;x++)if(!(JSON.stringify([c[N][x].uid,b.uid].sort())in g)){var L=c[N][x].radius+b.radius;t.links.push({source:c[N][x],target:b,value:L/i,linkType:"fake_fake"}),g[JSON.stringify([c[N][x].uid,b.uid].sort())]=!0}c[N].push(b)}return t},t.addExtraLinks=function(i){if(typeof i>"u")return t;for(var u=0;u<i.length;u++){var c=t.getNodeFromNucleotides(i[u].from),p=t.getNodeFromNucleotides(i[u].to),g={source:c,target:p,linkType:"extra",extraLinkType:i[u].linkType,uid:K.nice()};t.links.push(g)}return t},t.elementsToJson=function(){var i=t.pairtable;t.elements,t.nodes=[],t.links=[];var u={};t.elements.sort();for(let g=0;g<t.elements.length;g++){var c=t.elements[g][2];for(let m=0;m<c.length;m++)u[c[m]]=t.elements[g][0]}for(let g=1;g<=i[0];g++){var p=t.seq[g-1];(t.dotBracketBreaks.indexOf(g-1)>=0||t.dotBracketBreaks.indexOf(g-2)>=0)&&(p=""),t.nodes.push({name:p,num:o+g-1,radius:5,rna:t,nodeType:"nucleotide",structName:t.structName,elemType:u[g],uid:K.nice(),linked:!1})}for(let g=0;g<t.nodes.length;g++)g===0?t.nodes[g].prevNode=null:t.nodes[g].prevNode=t.nodes[g-1],g==t.nodes.length-1?t.nodes[g].nextNode=null:t.nodes[g].nextNode=t.nodes[g+1];for(let g=1;g<=i[0];g++)i[g]!==0&&t.links.push({source:t.nodes[g-1],target:t.nodes[i[g]-1],linkType:"basepair",value:1,uid:K.nice()}),g>1&&t.dotBracketBreaks.indexOf(g-1)===-1&&t.dotBracketBreaks.indexOf(g-2)==-1&&t.dotBracketBreaks.indexOf(g-3)==-1&&(t.links.push({source:t.nodes[g-2],target:t.nodes[g-1],linkType:"backbone",value:1,uid:K.nice()}),t.nodes[g-1].linked=!0);for(let g=0;g<t.pseudoknotPairs.length;g++)t.links.push({source:t.nodes[t.pseudoknotPairs[g][0]-1],target:t.nodes[t.pseudoknotPairs[g][1]-1],linkType:"pseudoknot",value:1,uid:K.nice()});return t.circular&&t.links.push({source:t.nodes[0],target:t.nodes[t.rnaLength-1],linkType:"backbone",value:1,uid:K.nice()}),t},t.ptToElements=function(i,u,c,p){var g=[],m=[c-1],b=[p+1];if(c>p)return[];for(;i[c]===0;c++)m.push(c);for(;i[p]===0;p--)b.push(p);if(c>p){if(m.push(c),u===0)return[["e",u,m.sort(Ne)]];for(var k=!1,N=[],x=[],L=0;L<m.length;L++)k?x.push(m[L]):N.push(m[L]),t.dotBracketBreaks.indexOf(m[L])>=0&&(k=!0);return k?[["h",u,m.sort(Ne)]]:[["h",u,m.sort(Ne)]]}if(i[c]!=p){var M=m,L=c;for(M.push(L);L<=p;){for(g=g.concat(t.ptToElements(i,u,L,i[L])),M.push(i[L]),L=i[L]+1;i[L]===0&&L<=p;L++)M.push(L);M.push(L)}return M.pop(),M=M.concat(b),M.length>0&&(u===0?g.push(["e",u,M.sort(Ne)]):g.push(["m",u,M.sort(Ne)])),g}if(i[c]===p){m.push(c),b.push(p);var T=m.concat(b);T.length>4&&(u===0?g.push(["e",u,m.concat(b).sort(Ne)]):g.push(["i",u,m.concat(b).sort(Ne)]))}for(var v=[];i[c]===p&&c<p;)v.push(c),v.push(p),c+=1,p-=1,u+=1;return m=[c-1],b=[p+1],g.push(["s",u,v.sort(Ne)]),g.concat(t.ptToElements(i,u,c,p))},t.addLabels=function(i=1,u=10){if(u===0)return t;for(let N=1;N<=t.rnaLength;N++)if(N%u===0){let x,L,M=t.nodes[N-1],T,v,_,I;t.rnaLength==1?(I=[M.x-15,M.y],_=[M.x-15,M.y]):(N==1?T=t.nodes[t.rnaLength-1]:T=t.nodes[N-2],N==t.rnaLength?v=t.nodes[0]:v=t.nodes[N],t.pairtable[v.num-i+1]!==0&&t.pairtable[T.num-i+1]!==0&&t.pairtable[M.num-i+1]!==0&&(T=v=t.nodes[t.pairtable[M.num-i+1]-1]),t.pairtable[M.num-i+1]!==0&&(t.pairtable[v.num-i+1]===0||t.pairtable[T.num-i+1]===0)?(I=[M.x-v.x,M.y-v.y],_=[M.x-T.x,M.y-T.y]):(I=[v.x-M.x,v.y-M.y],_=[T.x-M.x,T.y-M.y]));var c=[I[0]+_[0],I[1]+_[1]],p=Math.sqrt(c[0]*c[0]+c[1]*c[1]),g=[c[0]/p,c[1]/p],m=[-15*g[0],-15*g[1]];x=t.nodes[N-1].x+m[0],L=t.nodes[N-1].y+m[1];var b={name:N+i-1,num:-1,radius:6,rna:t,nodeType:"label",structName:t.structName,elemType:"l",x,y:L,px:x,py:L,uid:K.nice()},k={source:t.nodes[N-1],target:b,value:1,linkType:"label_link",uid:K.nice()};t.nodes.push(b),t.links.push(k)}return t},t.recalculateElements=function(){if(t.removePseudoknots(),t.elements=t.ptToElements(t.pairtable,0,1,t.dotbracket.length),t.circular){let i=t.elements.filter(function(u){if(u[0]=="e")return!0});if(i.length>0){eloop=i[0],nucs=eloop[2].sort(Ne),prev=nucs[0],hloop=!0,numGreater=0;for(let u=1;u<nucs.length;u++)nucs[u]-prev>1&&(numGreater+=1),prev=nucs[u];numGreater==1?eloop[0]="h":numGreater==2?eloop[0]="i":eloop[0]="m"}}return t},t.reassignLinkUids=function(){for(var i,i=0;i<t.links.length;i++)t.links[i].uid=t.links[i].source.uid+t.links[i].target.uid;return t},t.removePseudoknots=function(){return t.pairtable.length>1&&(t.pseudoknotPairs=t.pseudoknotPairs.concat(we.removePseudoknotsFromPairtable(t.pairtable))),t},t.addPseudoknots=function(){for(var i=t.pairtable,u=t.pseudoknotPairs,c=0;c<u.length;c++)i[u[c][0]]=u[c][1],i[u[c][1]]=u[c][0];return t.pseudoknotPairs=[],t},t.addName=function(i){return typeof i>"u"?(t.name="",t):(t.name=i,t)},t.rnaLength>0&&t.recalculateElements(),t.getNodeFromNucleotides=function(i){if(Object.prototype.toString.call(i)==="[object Array]"){for(let u=0;u<t.nodes.length;u++)if("nucs"in t.nodes[u]&&t.nodes[u].nucs.equals(i))return t.nodes[u]}else for(let u=0;u<t.nodes.length;u++)if(t.nodes[u].num==i)return t.nodes[u];return console.log("ERROR: No node found for nucs:",i),null}}function ut(s){var n=0,e=100,o=100,t=15,a=[],i=[],u,c,p;c=s[0];var g=Array.apply(null,new Array(c+5)).map(Number.prototype.valueOf,0),m=Array.apply(null,new Array(16+Math.floor(c/5))).map(Number.prototype.valueOf,0),b=Array.apply(null,new Array(16+Math.floor(c/5))).map(Number.prototype.valueOf,0),k=0,N=0,x=Math.PI/2,L=function(T,v,_){var I=2,z=0,B=0,X,j,Y,$,ve,pe,D,G,ye,Z,le,ee,fe=Array.apply(null,new Array(3+Math.floor((v-T)/5)*2)).map(Number.prototype.valueOf,0);for(X=T-1,v++;T!=v;)if(j=_[T],!j||T==0)T++,I++,B++;else{I+=2,Y=T,$=j,fe[++z]=Y,fe[++z]=$,T=j+1,ve=Y,pe=$,G=0;do Y++,$--,G++;while(_[Y]==$&&_[Y]>Y);if(D=G-2,G>=2&&(g[ve+1+D]+=x,g[pe-1-D]+=x,g[ve]+=x,g[pe]+=x,G>2))for(;D>=1;D--)g[ve+D]=Math.PI,g[pe-D]=Math.PI;b[++N]=G,Y<=$&&L(Y,$,_)}for(ee=Math.PI*(I-2)/I,fe[++z]=v,ye=X<0?0:X,Z=1;Z<=z;Z++){for(le=fe[Z]-ye,D=0;D<=le;D++)g[ye+D]+=ee;if(Z>z)break;ye=fe[++Z]}m[++k]=B};L(0,c+1,s),m[k]-=2,p=n,a[0]=e,i[0]=o;var M=[];for(M.push([a[0],i[0]]),u=1;u<c;u++)a[u]=a[u-1]+t*Math.cos(p),i[u]=i[u-1]+t*Math.sin(p),M.push([a[u],i[u]]),p+=Math.PI-g[u+1];return M}function be(){this.radius=null,this.loopnumber=null,this.next=null,this.prev=null}be.prototype.getRadius=function(){return this.radius},be.prototype.setRadius=function(s){this.radius=s},be.prototype.getLoopnumber=function(){return this.loopnumber},be.prototype.setLoopnumber=function(s){this.loopnumber=s},be.prototype.getNext=function(){return this.next},be.prototype.setNext=function(s){this.next=s},be.prototype.getPrev=function(){return this.prev},be.prototype.setPrev=function(s){this.prev=s};function W(){this.nconnection=null,this.connections=[],this._connections=[],this.number=null,this.depth=null,this.mark=null,this.x=null,this.y=null,this.radius=null}W.prototype.getNconnection=function(){return this.nconnection},W.prototype.setNconnection=function(s){this.nconnection=s},W.prototype.setConnection=function(s,n){n!=null?this._connections[s]=n:(this._connections[s]||(this._connections[s]=new V),this._connections[s].setNull(!0))},W.prototype.getConnection=function(s){this._connections[s]||(this._connections[s]=new V);var n=this._connections[s];return n.isNull()?null:n},W.prototype.addConnection=function(s,n){this._connections.push(n)},W.prototype.getNumber=function(){return this.number},W.prototype.setNumber=function(s){this.number=s},W.prototype.getDepth=function(){return this.depth},W.prototype.setDepth=function(s){this.depth=s},W.prototype.isMark=function(){return this.mark},W.prototype.setMark=function(s){this.mark=s},W.prototype.getX=function(){return this.x},W.prototype.setX=function(s){this.x=s},W.prototype.getY=function(){return this.y},W.prototype.setY=function(s){this.y=s},W.prototype.getRadius=function(){return this.radius},W.prototype.setRadius=function(s){this.radius=s};function he(){this._start1=null,this._end1=null,this._start2=null,this._end2=null}he.prototype.getStart1=function(){return this._start1},he.prototype.setStart1=function(s){this._start1=s},he.prototype.getEnd1=function(){return this._end1},he.prototype.setEnd1=function(s){this._end1=s},he.prototype.getStart2=function(){return this._start2},he.prototype.setStart2=function(s){this._start2=s},he.prototype.getEnd2=function(){return this._end2},he.prototype.setEnd2=function(s){this._end2=s};function V(){this.loop=new W,this.region=new he,this.start=null,this.end=null,this.xrad=null,this.yrad=null,this.angle=null,this.extruded=null,this.broken=null,this._isNull=!1}V.prototype.isNull=function(){return this._isNull},V.prototype.setNull=function(s){this._isNull=s},V.prototype.getLoop=function(){return this.loop},V.prototype.setLoop=function(s){this.loop=s},V.prototype.getRegion=function(){return this.region},V.prototype.setRegion=function(s){this.region=s},V.prototype.getStart=function(){return this.start},V.prototype.setStart=function(s){this.start=s},V.prototype.getEnd=function(){return this.end},V.prototype.setEnd=function(s){this.end=s},V.prototype.getXrad=function(){return this.xrad},V.prototype.setXrad=function(s){this.xrad=s},V.prototype.getYrad=function(){return this.yrad},V.prototype.setYrad=function(s){this.yrad=s},V.prototype.getAngle=function(){return this.angle},V.prototype.setAngle=function(s){this.angle=s},V.prototype.isExtruded=function(){return this.extruded},V.prototype.setExtruded=function(s){this.extruded=s},V.prototype.isBroken=function(){return this.broken},V.prototype.setBroken=function(s){this.broken=s};function de(){this.mate=null,this.x=null,this.y=null,this.extracted=null,this.region=new he}de.prototype.getMate=function(){return this.mate},de.prototype.setMate=function(s){this.mate=s},de.prototype.getX=function(){return this.x},de.prototype.setX=function(s){this.x=s},de.prototype.getY=function(){return this.y},de.prototype.setY=function(s){this.y=s},de.prototype.isExtracted=function(){return this.extracted},de.prototype.setExtracted=function(s){this.extracted=s},de.prototype.getRegion=function(){return this.region},de.prototype.setRegion=function(s){this.region=s};function ne(){this.ANUM=9999,this.MAXITER=500,this.bases=[],this.nbase=null,this.nregion=null,this.loop_count=null,this.root=new W,this.loops=[],this.regions=[],this.rlphead=new be,this.lencut=.8,this.RADIUS_REDUCTION_FACTOR=1.4,this.angleinc=null,this._h=null,this.HELIX_FACTOR=.6,this.BACKBONE_DISTANCE=27}ne.prototype.naview_xy_coordinates=function(s){var n=[],e=[];if(s.length===0||s[0]===0)return 0;var o;this.nbase=s[0],this.bases=[];for(var t=0;t<this.nbase+1;t++)this.bases.push(new de);this.regions=[];for(var t=0;t<this.nbase+1;t++)this.regions.push(new he);this.read_in_bases(s),this.rlphead=null,this.find_regions(),this.loop_count=0,this.loops=[];for(var t=0;t<this.nbase+1;t++)this.loops.push(new W);for(this.construct_loop(0),this.find_central_loop(),this.traverse_loop(this.root,null),o=0;o<this.nbase;o++)n.push(100+this.BACKBONE_DISTANCE*this.bases[o+1].getX()),e.push(100+this.BACKBONE_DISTANCE*this.bases[o+1].getY());return{nbase:this.nbase,x:n,y:e}},ne.prototype.read_in_bases=function(n){var e=null,o=null;for(this.bases.push(new de),this.bases[0].setMate(0),this.bases[0].setExtracted(!1),this.bases[0].setX(this.ANUM),this.bases[0].setY(this.ANUM),o=0,e=1;e<=this.nbase;e++)this.bases.push(new de),this.bases[e].setExtracted(!1),this.bases[e].setX(this.ANUM),this.bases[e].setY(this.ANUM),this.bases[e].setMate(n[e]),n[e]>e&&o++;o==0&&(this.bases[1].setMate(this.nbase),this.bases[this.nbase].setMate(1))},ne.prototype.find_regions=function(){var n=null,e=null,o=null;o=this.nbase+1;var t=[];for(n=0;n<o;n++)t.push(!1);for(this.nregion=0,n=0;n<=this.nbase;n++)if((e=this.bases[n].getMate())!=0&&!t[n]){for(this.regions[this.nregion].setStart1(n),this.regions[this.nregion].setEnd2(e),t[n]=!0,t[e]=!0,this.bases[n].setRegion(this.regions[this.nregion]),this.bases[e].setRegion(this.regions[this.nregion]),n++,e--;n<e&&this.bases[n].getMate()==e;n++,e--)t[e]=!0,t[n]=!0,this.bases[n].setRegion(this.regions[this.nregion]),this.bases[e].setRegion(this.regions[this.nregion]);this.regions[this.nregion].setEnd1(--n),this.regions[this.nregion].setStart2(e+1),this.nregion++}},ne.prototype.construct_loop=function(n){var e=null,o=null,t=new W,a=new W,i=new V,u=new he,c=new be;for(t=this.loops[this.loop_count++],t.setNconnection(0),t.setDepth(0),t.setNumber(this.loop_count),t.setRadius(0),c=this.rlphead;c!=null;c=c.getNext())c.getLoopnumber()==this.loop_count&&t.setRadius(c.getRadius());e=n;do(o=this.bases[e].getMate())!=0&&(u=this.bases[e].getRegion(),this.bases[u.getStart1()].isExtracted()||(e==u.getStart1()?(this.bases[u.getStart1()].setExtracted(!0),this.bases[u.getEnd1()].setExtracted(!0),this.bases[u.getStart2()].setExtracted(!0),this.bases[u.getEnd2()].setExtracted(!0),a=this.construct_loop(u.getEnd1()<this.nbase?u.getEnd1()+1:0)):e==u.getStart2()?(this.bases[u.getStart2()].setExtracted(!0),this.bases[u.getEnd2()].setExtracted(!0),this.bases[u.getStart1()].setExtracted(!0),this.bases[u.getEnd1()].setExtracted(!0),a=this.construct_loop(u.getEnd2()<this.nbase?u.getEnd2()+1:0)):console.log("Something went terribly wrong ...."),t.setNconnection(t.getNconnection()+1),i=new V,t.setConnection(t.getNconnection()-1,i),t.setConnection(t.getNconnection(),null),i.setLoop(a),i.setRegion(u),e==u.getStart1()?(i.setStart(u.getStart1()),i.setEnd(u.getEnd2())):(i.setStart(u.getStart2()),i.setEnd(u.getEnd1())),i.setExtruded(!1),i.setBroken(!1),a.setNconnection(a.getNconnection()+1),i=new V,a.setConnection(a.getNconnection()-1,i),a.setConnection(a.getNconnection(),null),i.setLoop(t),i.setRegion(u),e==u.getStart1()?(i.setStart(u.getStart2()),i.setEnd(u.getEnd1())):(i.setStart(u.getStart1()),i.setEnd(u.getEnd2())),i.setExtruded(!1),i.setBroken(!1)),e=o),++e>this.nbase&&(e=0);while(e!=n);return t},ne.prototype.find_central_loop=function(){var n=new W,e=null,o=null,t=null;for(Bt.bind(this)(),e=0,o=-1,t=0;t<this.loop_count;t++)n=this.loops[t],n.getNconnection()>e?(o=n.getDepth(),e=n.getNconnection(),this.root=n):n.getDepth()>o&&n.getNconnection()==e&&(o=n.getDepth(),this.root=n)};function Bt(){var s=new W,n=null,e=null;for(n=0;n<this.loop_count;n++){for(s=this.loops[n],e=0;e<this.loop_count;e++)this.loops[e].setMark(!1);s.setDepth(ct(s))}}function ct(s){var n=null,e=null,o=null;if(s.getNconnection()<=1)return 0;if(s.isMark())return-1;s.setMark(!0),n=0,e=0;for(var t=0;s.getConnection(t)!=null;t++)o=ct(s.getConnection(t).getLoop()),o>=0&&(++n==1||e>o)&&(e=o);return s.setMark(!1),e+1}ne.prototype.traverse_loop=function(n,e){var o,t,a,i,u,c,p,g,m,b,k,N,x,L,M,T,v,_,I,z,B,X,j,Y,$,ve,pe,D,G,ye,Z,le,ee,fe,ge,Te,ke,Ee,_e,Xe,Ye,Pe,Ce,Oe,l,f,d,y,h,w,A,P,C,E,q,R,J,re,Q,O,H,xe,Ue,Re,Ae,ue,F,ce,Ve,He,We,$e=0;p=2*Math.PI/(this.nbase+1),I=null,Z=-1;var dt=0;for(Y=0;(v=n.getConnection(dt))!=null;dt++,Y++)o=-Math.sin(p*v.getStart()),t=Math.cos(p*v.getStart()),a=-Math.sin(p*v.getEnd()),i=Math.cos(p*v.getEnd()),u=i-t,c=o-a,g=Math.sqrt(u*u+c*c),v.setXrad(u/g),v.setYrad(c/g),v.setAngle(Math.atan2(c,u)),v.getAngle()<0&&v.setAngle(v.getAngle()+2*Math.PI),e!=null&&e.getRegion()==v.getRegion()&&(I=v,Z=Y);e:for(;;){this.determine_radius(n,this.lencut),m=n.getRadius()/this.RADIUS_REDUCTION_FACTOR,e==null?b=k=0:(N=(this.bases[I.getStart()].getX()+this.bases[I.getEnd()].getX())/2,x=(this.bases[I.getStart()].getY()+this.bases[I.getEnd()].getY())/2,b=N-m*I.getXrad(),k=x-m*I.getYrad()),Z==-1?D=0:D=Z,v=n.getConnection(D),pe=0,le=!1;do if(X=D-1,X<0&&(X=n.getNconnection()-1),z=n.getConnection(X),this.connected_connection(z,v)?(D=X,v=z):le=!0,++pe>n.getNconnection()){for(ve=-1,Y=0;Y<n.getNconnection();Y++)X=Y+1,X>=n.getNconnection()&&(X=0),v=n.getConnection(Y),_=n.getConnection(X),F=_.getAngle()-v.getAngle(),F<0&&(F+=2*Math.PI),F>ve&&(ve=F,$e=Y);G=$e,D=$e+1,D>=n.getNconnection()&&(D=0),v=n.getConnection(G),v.setBroken(!0),le=!0}while(!le);for(ee=!1,d=D;!ee;){for(pe=0,le=!1,G=D,fe=!1;!le;)if(v=n.getConnection(G),G==Z&&(fe=!0),X=G+1,X>=n.getNconnection()&&(X=0),_=n.getConnection(X),this.connected_connection(v,_)){if(++pe>=n.getNconnection())break;G=X}else le=!0;for(ye=this.find_ic_middle(D,G,e,I,n),Y=y=h=ye,le=!1,A=0;!le;)A<0?Y=y:A==0?Y=ye:Y=h,Y>=0&&(v=n.getConnection(Y),(e==null||I!=v)&&(A==0?(L=v.getAngle()-Math.asin(1/2/m),M=v.getAngle()+Math.asin(1/2/m),this.bases[v.getStart()].setX(b+m*Math.cos(L)),this.bases[v.getStart()].setY(k+m*Math.sin(L)),this.bases[v.getEnd()].setX(b+m*Math.cos(M)),this.bases[v.getEnd()].setY(k+m*Math.sin(M))):A<0?(X=Y+1,X>=n.getNconnection()&&(X=0),v=n.getConnection(Y),_=n.getConnection(X),R=v.getXrad(),J=v.getYrad(),F=(v.getAngle()+_.getAngle())/2,v.getAngle()>_.getAngle()&&(F-=Math.PI),O=Math.cos(F),H=Math.sin(F),Re=H,Ae=-O,$=_.getAngle()-v.getAngle(),$<0&&($+=2*Math.PI),v.isExtruded()?$<=Math.PI/2?ue=2:ue=1.5:ue=1,this.bases[v.getEnd()].setX(this.bases[_.getStart()].getX()+ue*Re),this.bases[v.getEnd()].setY(this.bases[_.getStart()].getY()+ue*Ae),this.bases[v.getStart()].setX(this.bases[v.getEnd()].getX()+J),this.bases[v.getStart()].setY(this.bases[v.getEnd()].getY()-R)):(X=Y-1,X<0&&(X=n.getNconnection()-1),v=n.getConnection(X),_=n.getConnection(Y),re=_.getXrad(),Q=_.getYrad(),F=(v.getAngle()+_.getAngle())/2,v.getAngle()>_.getAngle()&&(F-=Math.PI),O=Math.cos(F),H=Math.sin(F),Re=-H,Ae=O,$=_.getAngle()-v.getAngle(),$<0&&($+=2*Math.PI),v.isExtruded()?$<=Math.PI/2?ue=2:ue=1.5:ue=1,this.bases[_.getStart()].setX(this.bases[v.getEnd()].getX()+ue*Re),this.bases[_.getStart()].setY(this.bases[v.getEnd()].getY()+ue*Ae),this.bases[_.getEnd()].setX(this.bases[_.getStart()].getX()-Q),this.bases[_.getEnd()].setY(this.bases[_.getStart()].getY()+re)))),A<0?(h==G?h=-1:h>=0&&++h>=n.getNconnection()&&(h=0),A=1):(y==D?y=-1:y>=0&&--y<0&&(y=n.getNconnection()-1),A=-1),le=y==-1&&h==-1;if(w=G+1,w>=n.getNconnection()&&(w=0),G!=D&&!(D==d&&w==d))if(v=n.getConnection(D),_=n.getConnection(G),C=this.bases[_.getEnd()].getX()-this.bases[v.getStart()].getX(),E=this.bases[_.getEnd()].getY()-this.bases[v.getStart()].getY(),Te=this.bases[v.getStart()].getX()+C/2,ke=this.bases[v.getStart()].getY()+E/2,q=Math.sqrt(C*C+E*E),Xe=C/q,Ye=E/q,Pe=b-Te,Ce=k-ke,q=Math.sqrt(C*C+E*E),Pe/=q,Ce/=q,Oe=Pe*Xe+Ce*Ye,Ee=Oe*Xe-Pe,_e=Oe*Ye-Ce,q=Math.sqrt(Ee*Ee+_e*_e),Ee/=q,_e/=q,C=this.bases[v.getStart()].getX()-b,E=this.bases[v.getStart()].getY()-k,F=Math.atan2(E,C),F<0&&(F+=2*Math.PI),C=this.bases[_.getEnd()].getX()-b,E=this.bases[_.getEnd()].getY()-k,ce=Math.atan2(E,C),ce<0&&(ce+=2*Math.PI),ce<F&&(ce+=2*Math.PI),ce-F>Math.PI?ge=-1:ge=1,l=b+ge*m*Ee,f=k+ge*m*_e,fe)b-=l-Te,k-=f-ke;else for(Y=D;v=n.getConnection(Y),B=v.getStart(),this.bases[B].setX(this.bases[B].getX()+l-Te),this.bases[B].setY(this.bases[B].getY()+f-ke),B=v.getEnd(),this.bases[B].setX(this.bases[B].getX()+l-Te),this.bases[B].setY(this.bases[B].getY()+f-ke),Y!=G;)++Y>=n.getNconnection()&&(Y=0);D=w,ee=D==d}for(Y=0;Y<n.getNconnection();Y++){if(v=n.getConnection(Y),X=Y+1,X>=n.getNconnection()&&(X=0),_=n.getConnection(X),C=this.bases[v.getEnd()].getX()-b,E=this.bases[v.getEnd()].getY()-k,Ue=Math.sqrt(C*C+E*E),F=Math.atan2(E,C),F<0&&(F+=2*Math.PI),C=this.bases[_.getStart()].getX()-b,E=this.bases[_.getStart()].getY()-k,xe=Math.sqrt(C*C+E*E),ce=Math.atan2(E,C),ce<0&&(ce+=2*Math.PI),ce<F&&(ce+=2*Math.PI),P=ce-F,We=_.getAngle()-v.getAngle(),We<=0&&(We+=2*Math.PI),Math.abs(P-We)>Math.PI){if(v.isExtruded())console.log("Warning from traverse_loop. Loop "+n.getNumber()+` has crossed regions
`);else if(_.getStart()-v.getEnd()!=1){v.setExtruded(!0);continue e}}if(v.isExtruded())this.construct_extruded_segment(v,_);else for(j=_.getStart()-v.getEnd(),j<0&&(j+=this.nbase+1),p=P/j,X=1;X<j;X++)B=v.getEnd()+X,B>this.nbase&&(B-=this.nbase+1),T=F+X*p,q=Ue+(xe-Ue)*(T-F)/P,this.bases[B].setX(b+q*Math.cos(T)),this.bases[B].setY(k+q*Math.sin(T))}break}for(Y=0;Y<n.getNconnection();Y++)Z!=Y&&(v=n.getConnection(Y),this.generate_region(v),this.traverse_loop(v.getLoop(),v));for(j=0,Ve=0,He=0,Y=0;Y<n.getNconnection();Y++)if(X=Y+1,X>=n.getNconnection()&&(X=0),v=n.getConnection(Y),_=n.getConnection(X),j+=2,Ve+=this.bases[v.getStart()].getX()+this.bases[v.getEnd()].getX(),He+=this.bases[v.getStart()].getY()+this.bases[v.getEnd()].getY(),!v.isExtruded())for(X=v.getEnd()+1;X!=_.getStart();X++)X>this.nbase&&(X-=this.nbase+1),j++,Ve+=this.bases[X].getX(),He+=this.bases[X].getY();n.setX(Ve/j),n.setY(He/j)},ne.prototype.determine_radius=function(n,e){var o,t,a,i,u,c,p,g,m,b,k,N=0,x=new V,L=new V,M=.7071068;do{for(o=1e10,u=0,i=0,g=0;g<n.getNconnection();g++)x=n.getConnection(g),m=g+1,m>=n.getNconnection()&&(m=0),L=n.getConnection(m),b=x.getEnd(),k=L.getStart(),k<b&&(k+=this.nbase+1),a=L.getAngle()-x.getAngle(),a<=0&&(a+=2*Math.PI),x.isExtruded()?a<=Math.PI/2?t=2:t=1.5:t=k-b,i+=a*(1/t+1),u+=a*a/t,p=a/t,p<o&&!x.isExtruded()&&t>1&&(o=p,N=g);c=i/u,c<M&&(c=M),o*c<e&&n.getConnection(N).setExtruded(!0)}while(o*c<e);n.getRadius()>0?c=n.getRadius():n.setRadius(c)},ne.prototype.find_ic_middle=function(n,e,o,t,a){var i,u,c,p,g;for(i=0,u=-1,c=n,g=!1;!g;)i++>a.getNconnection()*2&&console.log("Infinite loop in 'find_ic_middle'"),o!=null&&a.getConnection(c)==t&&(u=c),g=c==e,++c>=a.getNconnection()&&(c=0);if(u==-1){for(p=1,c=n;p<(i+1)/2;p++)++c>=a.getNconnection()&&(c=0);u=c}return u},ne.prototype.construct_extruded_segment=function(n,e){var o,t,a,i,u,c,p,g,m,b,k,N,x,L,M,T,v,_;if(o=n.getAngle(),a=t=e.getAngle(),a<o&&(a+=2*Math.PI),i=(o+a)/2,x=n.getEnd(),L=e.getStart(),M=L-x,M<0&&(M+=this.nbase+1),k=e.getAngle()-n.getAngle(),k<0&&(k+=2*Math.PI),M==2)this.construct_circle_segment(x,L);else{u=this.bases[L].getX()-this.bases[x].getX(),c=this.bases[L].getY()-this.bases[x].getY(),b=Math.sqrt(u*u+c*c),u/=b,c/=b,b>=1.5&&k<=Math.PI/2&&(T=x+1,T>this.nbase&&(T-=this.nbase+1),v=L-1,v<0&&(v+=this.nbase+1),this.bases[T].setX(this.bases[x].getX()+.5*u),this.bases[T].setY(this.bases[x].getY()+.5*c),this.bases[v].setX(this.bases[L].getX()-.5*u),this.bases[v].setY(this.bases[L].getY()-.5*c),x=T,L=v);do _=!1,this.construct_circle_segment(x,L),T=x+1,T>this.nbase&&(T-=this.nbase+1),u=this.bases[T].getX()-this.bases[x].getX(),c=this.bases[T].getY()-this.bases[x].getY(),p=Math.atan2(c,u),p<0&&(p+=2*Math.PI),N=p-o,N<0&&(N+=2*Math.PI),N>Math.PI&&(_=!0),v=L-1,v<0&&(v+=this.nbase+1),u=this.bases[v].getX()-this.bases[L].getX(),c=this.bases[v].getY()-this.bases[L].getY(),g=Math.atan2(c,u),g<0&&(g+=2*Math.PI),N=t-g,N<0&&(N+=2*Math.PI),N>Math.PI&&(_=!0),_&&(m=this.minf2(i,o+.5),this.bases[T].setX(this.bases[x].getX()+Math.cos(m)),this.bases[T].setY(this.bases[x].getY()+Math.sin(m)),x=T,m=this.maxf2(i,a-.5),this.bases[v].setX(this.bases[L].getX()+Math.cos(m)),this.bases[v].setY(this.bases[L].getY()+Math.sin(m)),L=v,M-=2);while(_&&M>1)}},ne.prototype.construct_circle_segment=function(n,e){var o,t,a,i,u,c,p,g,m,b,k,N,x,L,M;if(o=this.bases[e].getX()-this.bases[n].getX(),t=this.bases[e].getY()-this.bases[n].getY(),a=Math.sqrt(o*o+t*t),x=e-n,x<0&&(x+=this.nbase+1),a>=x)for(o/=a,t/=a,L=1;L<x;L++)M=n+L,M>this.nbase&&(M-=this.nbase+1),this.bases[M].setX(this.bases[n].getX()+o*L/x),this.bases[M].setY(this.bases[n].getY()+t*L/x);else for(this.find_center_for_arc(x-1,a),o/=a,t/=a,i=this.bases[n].getX()+o*a/2,u=this.bases[n].getY()+t*a/2,c=t,p=-o,g=i+this._h*c,m=u+this._h*p,b=this.bases[n].getX()-g,k=this.bases[n].getY()-m,a=Math.sqrt(b*b+k*k),N=Math.atan2(k,b),L=1;L<x;L++)M=n+L,M>this.nbase&&(M-=this.nbase+1),this.bases[M].setX(g+a*Math.cos(N+L*this.angleinc)),this.bases[M].setY(m+a*Math.sin(N+L*this.angleinc))},ne.prototype.find_center_for_arc=function(n,e){var o,t,a,i,u,c,p,g,m;t=(n+1)/Math.PI,a=-t-e/(n+1.000001-e),e<1&&(a=0),m=0;do o=(t+a)/2,i=Math.sqrt(o*o+e*e/4),u=1-.5/(i*i),Math.abs(u)>1&&console.log("Unexpected large magnitude discriminant = "+u+" "+i),c=Math.acos(u),g=Math.acos(o/i),p=c*(n+1)+2*g-2*Math.PI,p>0?a=o:t=o;while(Math.abs(p)>1e-4&&++m<this.MAXITER);m>=this.MAXITER&&(noIterationFailureYet&&(console.log("Iteration failed in find_center_for_arc"),noIterationFailureYet=!1),o=0,c=0),this._h=o,this.angleinc=c},ne.prototype.generate_region=function(n){var e,o,t,a,i,u;for(u=n.getRegion(),e=0,n.getStart()==u.getStart1()?(o=u.getStart1(),t=u.getEnd1()):(o=u.getStart2(),t=u.getEnd2()),(this.bases[n.getStart()].getX()>this.ANUM-100||this.bases[n.getEnd()].getX()>this.ANUM-100)&&console.log("Bad region passed to generate_region. Coordinates not defined."),a=o+1;a<=t;a++)e++,this.bases[a].setX(this.bases[n.getStart()].getX()+this.HELIX_FACTOR*e*n.getXrad()),this.bases[a].setY(this.bases[n.getStart()].getY()+this.HELIX_FACTOR*e*n.getYrad()),i=this.bases[a].getMate(),this.bases[i].setX(this.bases[n.getEnd()].getX()+this.HELIX_FACTOR*e*n.getXrad()),this.bases[i].setY(this.bases[n.getEnd()].getY()+this.HELIX_FACTOR*e*n.getYrad())},ne.prototype.minf2=function(n,e){return n<e?n:e},ne.prototype.maxf2=function(n,e){return n>e?n:e},ne.prototype.connected_connection=function(n,e){return n.isExtruded()?!0:n.getEnd()+1==e.getStart()};function qt(s,n={}){var e=this;let o={editable:!1,zoomable:!0,animation:!0,displayAllLinks:!1,labelInterval:10,chargeDistance:110,friction:.35,middleCharge:-30,otherCharge:-30,linkDistanceMultiplier:15,initialSize:null,layout:"standard-polygonal",transitionDuration:500,maxNodeRadius:80};e.options=Object.assign(o,n),e.options.initialSize!==null?(e.options.svgW=e.options.initialSize[0],e.options.svgH=e.options.initialSize[1]):(e.options.svgW=300,e.options.svgH=300),e.linkStrengths={pseudoknot:0,proteinChain:0,chainChain:0,intermolecule:10,external:0,other:10},e.displayParameters={displayNumbering:!0,displayNodeOutline:!0,displayNodeLabel:!0,displayLinks:!0,displayPseudoknotLinks:!0,displayProteinLinks:!0,displayDirectionArrows:!0},e.colorScheme="structure",e.customColors={},e.rnas={},e.extraLinks=[];var t=null,a=null;let i=!1,u=()=>{t=null,a=null};var c=e.graph={nodes:[],links:[]};if(Array.prototype.equals=function(l){if(!l||this.length!=l.length)return!1;for(var f=0,d=this.length;f<d;f++)if(this[f]instanceof Array&&l[f]instanceof Array){if(!this[f].equals(l[f]))return!1}else if(this[f]!=l[f])return!1;return!0},e.options.editable||e.options.animation){var p=!1,g=!1;let l=()=>{switch(S.event.keyCode){case 68:console.log("dotbracket:",e.getStructuresDotBracket());break;case 16:p=!0;break;case 17:g=!0;break;case 67:e.centerView();break}g&&(e.options.zoomable&&_(),(e.options.editable||e.options.animation)&&j())},f=()=>{p=!1,g=!1,e.options.zoomable&&v(),Y()};S.select("body").on("keydown",l).on("keyup",f).on("contextmenu",function(){S.event.preventDefault()})}if(e.options.editable){let l=[{title:"Add Node",action:function(d,y,h,w){},children:[{title:"A",action:function(d,y,h,w){console.log("mousePos:",w,e.options.svgW,e.options.svgH);let A=[M.invert(w[0]),T.invert(w[1])];console.log("canvasMousePos",A),e.addRNA(".",{sequence:"A",centerPos:A})}},{title:"C",action:function(d,y,h,w){console.log("mousePos:",w,e.options.svgW,e.options.svgH);let A=[M.invert(w[0]),T.invert(w[1])];console.log("canvasMousePos",A),e.addRNA(".",{sequence:"C",centerPos:A})}},{title:"G",action:function(d,y,h,w){console.log("mousePos:",w,e.options.svgW,e.options.svgH);let A=[M.invert(w[0]),T.invert(w[1])];console.log("canvasMousePos",A),e.addRNA(".",{sequence:"G",centerPos:A})}},{title:"U",action:function(d,y,h,w){console.log("mousePos:",w,e.options.svgW,e.options.svgH);let A=[M.invert(w[0]),T.invert(w[1])];console.log("canvasMousePos",A),e.addRNA(".",{sequence:"U",centerPos:A})}}],disabled:!1}],f=[{title:"Delete Node",action:function(d,y,h){Te(y)},disabled:!1},{title:"Change Node",action:function(d,y,h){console.log("You have clicked the second item!"),console.log("The data for this circle is: "+y)},children:[{title:"A",action:function(d,y,h){fe("A",y)}},{title:"C",action:function(d,y,h){fe("C",y)}},{title:"G",action:function(d,y,h){fe("G",y)}},{title:"U",action:function(d,y,h){fe("U",y)}}]},{title:"Insert Before",action:function(d,y,h){},children:[{title:"A",action:function(d,y,h){ge("A",y,-1)}},{title:"C",action:function(d,y,h){ge("C",y,-1)}},{title:"G",action:function(d,y,h){ge("G",y,-1)}},{title:"U",action:function(d,y,h){ge("U",y,-1)}}]},{title:"Insert After",action:function(d,y,h){console.log("d:",y)},children:[{title:"A",action:function(d,y,h){ge("A",y,0)}},{title:"C",action:function(d,y,h){ge("C",y,0)}},{title:"G",action:function(d,y,h){ge("G",y,0)}},{title:"U",action:function(d,y,h){ge("U",y,0)}}]}];e.nodeContextMenu=Ie(f),e.backgroundContextMenu=Ie(l)}else e.nodeContextMenu=function(){};S.select(s).select("svg").remove();var m=S.select(s).attr("tabindex",1).each(function(){this.focus()}).append("svg:svg").attr("preserveAspectRatio","xMidYMid meet").attr("viewBox","0 0 "+e.options.svgW+" "+e.options.svgH);if(e.options.svg=m,e.options.editable||e.options.animation){var b=m.append("svg:g").on("mousemove",()=>{if(!t)return;let l=S.mouse(k.node());L.attr("x1",t.x).attr("y1",t.y).attr("x2",l[0]).attr("y2",l[1])}).on("mousedown",()=>{}).on("mouseup",()=>{t&&!i&&L.classed(U.transparent,!0),u()}).classed(U.mouseEventHelper,!0).style("pointer-events","all");b.append("svg:rect").classed("background",!0).style("visibility","hidden").attr("width",e.options.svgW).attr("height",e.options.svgH).on("mousedown",function(){B()})}else var b=m;var k=b.append("svg:g").classed(U.plot,!0),N=k.append("svg:g").classed("fornac-links",!0),x=k.append("svg:g").classed("fornac-nodes",!0);if(e.options.editable){var L=k.append("line").attr("class",U.dragLine).attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",0);m.on("contextmenu",e.backgroundContextMenu)}var M=S.scale.linear().domain([0,e.options.svgW]).range([0,e.options.svgW]),T=S.scale.linear().domain([0,e.options.svgH]).range([0,e.options.svgH]);e.zoomer=S.behavior.zoom().scaleExtent([.1,10]).x(M).y(T).on("zoom",()=>{k.attr("transform","translate("+S.event.translate+") scale("+S.event.scale+")")});let v=()=>{m.call(e.zoomer).on("dblclick.zoom",null)},_=()=>{m.call(e.zoomer).on("dblclick.zoom",null).on("mousedown.zoom",null).on("touchstart.zoom",null).on("touchmove.zoom",null).on("touchend.zoom",null)};e.options.zoomable&&v();let I=l=>{l.selected=!l.selected,x.selectAll("g.gnode").filter(f=>l.uid==f.uid).classed(U.selectedNode,function(f){return f.selected})},z=l=>{l.selected=!0,x.selectAll("g.gnode").filter(f=>l.uid==f.uid).classed(U.selectedNode,function(f){return f.selected})},B=()=>{x.selectAll("g.gnode").classed(U.selectedNode,function(l){return l.selected=!1})},X=()=>x.selectAll("g.gnode").filter(function(l){return l.selected});e.brusher=S.svg.brush().x(M).y(T).on("brushstart",function(l){}).on("brush",function(){let l=S.event.target.extent();x.selectAll("g.gnode").classed(U.selectedNode,function(f){return f.selected^(l[0][0]<=f.x&&f.x<l[1][0]&&l[0][1]<=f.y&&f.y<l[1][1])})}).on("brushend",function(){let l=S.event.target.extent();x.selectAll("g.gnode").filter(function(f){return l[0][0]<=f.x&&f.x<l[1][0]&&l[0][1]<=f.y&&f.y<l[1][1]}).each(I),S.event.target.clear(),S.select(this).call(S.event.target)});let j=()=>{b.select(".background").style("cursor","crosshair"),b.call(e.brusher)},Y=()=>{b.select(".background").style("cursor","auto"),b.call(e.brusher).on("mousedown.brush",null).on("touchstart.brush",null).on("touchmove.brush",null).on("touchend.brush",null)};e.force=S.layout.force().charge(function(l){return l.nodeType=="middle"?e.options.middleCharge:e.options.otherCharge}).friction(e.options.friction).linkDistance(function(l){return e.options.linkDistanceMultiplier*l.value}).linkStrength(function(l){return l.linkType in e.linkStrengths?e.linkStrengths[l.linkType]:e.linkStrengths.other}).gravity(0).nodes(e.graph.nodes).links(e.graph.links).chargeDistance(e.options.chargeDistance).size([e.options.svgW,e.options.svgH]);var $=S.behavior.drag().on("dragstart",function(l){console.log("dragstart"),S.event.sourceEvent.stopPropagation(),X().each(function(f){f.fixed|=2})}).on("drag",l=>{p||(X().each(function(f){f.x+=S.event.dx,f.y+=S.event.dy,f.px+=S.event.dx,f.py+=S.event.dy}),e.resumeForce(),S.event.sourceEvent.preventDefault())}).on("dragend",l=>{console.log("dragend"),X().each(function(f){f.fixed&=-7})});let ve=function(l,f={}){let d={sequence:"",name:"empty",positions:[],labelInterval:e.options.labelInterval,avoidOthers:!0,uids:[],circularizeExternal:!0};d=Object.assign(d,f);let y=new ze(d.sequence,l,d.name);y.circularizeExternal=d.circularizeExternal;let h=y.recalculateElements();if(d.positions.length===0)if(e.options.layout=="naview"){let A=new ne().naview_xy_coordinates(y.pairtable);d.positions=[];for(let P=0;P<A.nbase;P++)d.positions.push([A.x[P],A.y[P]])}else d.positions=ut(h.pairtable);return h=h.elementsToJson().addUids(d.uids).addPositions("nucleotide",d.positions).addLabels(1,d.labelInterval).reinforceStems().reinforceLoops().connectFakeNodes().reassignLinkUids().breakNodesToFakeNodes(),h},pe=function(l){l=l.append("g").classed("gnode",!0).attr("struct_name",function(h){return h.structName}).attr("transform",function(h){return typeof h.x<"u"&&typeof h.y<"u"?"translate("+[h.x,h.y]+")":""}).each(function(h){h.selected=h.previouslySelected=!1}),l.attr("num",function(h){return"n"+h.num}).attr("rnum",function(h){return"n"+(h.rna.rnaLength-h.num+1)}).transition().duration(750).ease("elastic"),(e.options.editable||e.options.animation)&&l.on("mousedown",Ce).on("mouseup",Pe).on("contextmenu",e.nodeContextMenu).call($);let f=l.filter(function(h){return h.nodeType=="label"||h.nodeType=="protein"}),d=l.filter(function(h){return h.nodeType=="nucleotide"});f.append("svg:circle").classed(U.node,!0).attr("r",function(h){return h.nodeType=="middle"?0:h.radius}).attr("node_type",function(h){return h.nodeType}).attr("node_num",function(h){return h.num}),d.append("svg:path").attr("class",U.directionArrow).attr("node_num",function(h){return h.num}),d.append("svg:circle").attr("class",U.node).attr("node_type",function(h){return h.nodeType}).attr("node_num",function(h){return h.num}).attr("r",function(h){return h.radius}).append("svg:title").text(function(h){return h.nodeType=="nucleotide"?h.structName+":"+h.num:""});var y=l.append("text").text(function(h){return h.name}).attr("class",U.nodeLabel).attr("label_type",function(h){return h.nodeType});return y.append("svg:title").text(function(h){return h.nodeType=="nucleotide"?h.structName+":"+h.num:""}),l},D=function(l){var f=l.append("svg:line");return f.append("svg:title").text(d=>d.linkType+":"+d.source.num+"-"+d.target.num),f.classed("link",!0).classed(U.link,!0).attr("x1",function(d){return d.source.x}).attr("y1",function(d){return d.source.y}).attr("x2",function(d){return d.target.x}).attr("y2",function(d){return d.target.y}).attr("link_type",function(d){return d.linkType}).attr("pointer-events",function(d){return d.linkType=="fake"?"none":"all"}),e.options.editable&&f.on("click",Oe),f};function G(l){let f=R=>Math.sqrt(R[0]*R[0]+R[1]*R[1]),d=l,y=l.prevNode,h=parseFloat(U.nodeStrokeWidth)/2,w=parseFloat(U.directionArrowSize),A=parseFloat(U.directionArrowWidth);if(console.log(U),y===null||!l.linked)return;let P=[-(d.x-y.x),-(d.y-y.y)];if(P[0]==0&&P[1]==0)return;P=[P[0]/f(P),P[1]/f(P)];let C=[-P[1],P[0]],E=[(l.radius+h)*P[0],(l.radius+h)*P[1]],q="M"+(E[0]+w*(P[0]/2+C[0]*A/2))+","+(E[1]+w*(P[1]/2+C[1]*A/2))+"L"+E[0]+","+E[1]+"L"+(E[0]+w*(P[0]/2-C[0]*A/2))+","+(E[1]+w*(P[1]/2-C[1]*A/2));S.select(this).attr("d",q)}let ye=l=>l.linkType=="basepair"||l.linkType=="backbone"||l.linkType=="intermolecule"||l.linkType=="pseudoknot"||l.linkType=="label_link"||l.linkType=="external"||l.linkType=="chain_chain",Z=()=>{e.graph.nodes=[],e.graph.links=[];for(let f in e.rnas)e.graph.nodes=e.graph.nodes.concat(e.rnas[f].nodes),e.graph.links=e.graph.links.concat(e.rnas[f].links);var l={};for(let f=0;f<e.graph.nodes.length;f++)l[e.graph.nodes[f].uid]=e.graph.nodes[f];e.graph.links.forEach(function(f){f.source=l[f.source.uid],f.target=l[f.target.uid]});for(let f=0;f<e.extraLinks.length;f++){if(!(e.extraLinks[f].target.uid in l)){console.log("not there:",e.extraLinks[f]);continue}if(e.extraLinks[f].source=l[e.extraLinks[f].source.uid],e.extraLinks[f].target=l[e.extraLinks[f].target.uid],e.extraLinks[f].linkType=="intermolecule"){let d=e.graph.links.filter(function(y){return(y.source==e.extraLinks[f].source||y.source==e.extraLinks[f].target||y.target==e.extraLinks[f].source||y.target==e.extraLinks[f].source)&&y.linkType=="fake"});for(let y=0;y<d.length;y++){let h=e.graph.links.indexOf(d[y]);e.graph.links.splice(h,1)}}c.links.push(e.extraLinks[f])}};e.update=function(){e.force.nodes(e.graph.nodes).links(e.graph.links),e.options.animation&&e.force.start();let l=N.selectAll("line.link").data(e.graph.links.filter(ye),ke);l.attr("class","").classed("link",!0).classed(U.link,!0).attr("link_type",function(w){return w.linkType});let f=l.enter();D(f),l.exit().remove();let d=x.selectAll("g.gnode").data(e.graph.nodes,ke),y=d.enter();pe(y),d.exit().remove();let h=e.graph.nodes.filter(function(w){return w.nodeType=="nucleotide"||w.nodeType=="label"});d.select("."+U.directionArrow).each(G),e.force.on("tick",function(){let w=S.geom.quadtree(h),A=0,P=h.length,C=E=>{let q=E.radius+16,R=E.x-q,J=E.x+q,re=E.y-q,Q=E.y+q;return function(O,H,xe,Ue,Re){if(O.point&&O.point!==E){let Ae=E.x-O.point.x,ue=E.y-O.point.y,F=Math.sqrt(Ae*Ae+ue*ue),ce=E.radius+O.point.radius;F<ce&&(F=(F-ce)/F*.1,E.x-=Ae*=F,E.y-=ue*=F,O.point.x+=Ae,O.point.y+=ue)}return H>J||Ue<R||xe>Q||Re<re}};for(;++A<P;)w.visit(C(h[A]));l.attr("x1",function(E){return E.source.x}).attr("y1",function(E){return E.source.y}).attr("x2",function(E){return E.target.x}).attr("y2",function(E){return E.target.y}),d.attr("transform",function(E){return"translate("+[E.x,E.y]+")"}),d.select("."+U.directionArrow).each(G)}),e.force.on("end",()=>{d.selectAll("[node_type=nucleotide]").filter((w,A)=>A==0).each((w,A)=>{})}),e.changeColorScheme(e.colorScheme),e.options.animation&&e.force.start(),ee()},e.transitionRNA=function(l,f){if(e.dotbracket==l)return;e.dotbracket=l;var d=e.options.transitionDuration,y=e.graph.nodes.filter(function(R){return R.nodeType=="nucleotide"}).map(function(R){return R.uid}),w=ve(l,{uids:y});let A=x.selectAll("g.gnode").data(w.nodes,ke);var P=N.selectAll("line.link").data(w.links.filter(ye),ke);d===0?A.attr("transform",function(R){return"translate("+[R.x,R.y]+")"}):A.transition().attr("transform",function(R){return"translate("+[R.x,R.y]+")"}).duration(d);var C=pe(A.enter()).attr("transform",function(R){return typeof R.x<"u"&&typeof R.y<"u"?"translate(0,0)":""});d===0?A.exit().remove():A.exit().transition().attr("transform",function(R){return typeof R.x<"u"&&typeof R.y<"u"?"translate(0,0)":""}),e.graph.nodes=A.data(),A.select("."+U.directionArrow).each(G),e.changeColorScheme(e.colorScheme),ee(),e.centerView(d);function E(R,J){R.size()===0&&setTimeout(J,d);var re=0;R.each(function(){++re}).each("end",function(){--re||J.apply(this,arguments)})}function q(){D(P.enter()),e.graph.links=P.data(),e.changeColorScheme(e.colorScheme),ee(),typeof f<"u"&&f()}P.exit().remove(),d===0?(P.attr("x1",function(R){return R.source.x}).attr("y1",function(R){return R.source.y}).attr("x2",function(R){return R.target.x}).attr("y2",function(R){return R.target.y}),D(P.enter()),e.graph.links=P.data(),ee()):P.transition().attr("x1",function(R){return R.source.x}).attr("y1",function(R){return R.source.y}).attr("x2",function(R){return R.target.x}).attr("y2",function(R){return R.target.y}).duration(d).call(E,q),d===0?C.attr("transform",function(R){return typeof R.x<"u"&&typeof R.y<"u"?"translate("+[R.x,R.y]+")":""}):C.transition().attr("transform",function(R){return typeof R.x<"u"&&typeof R.y<"u"?"translate("+[R.x,R.y]+")":""})};let le=()=>{if(e.graph.nodes.length===0)return{translate:[0,0],scale:1};var l=S.min(e.graph.nodes.map(function(Q){return Q.x})),f=S.min(e.graph.nodes.map(function(Q){return Q.y})),d=S.max(e.graph.nodes.map(function(Q){return Q.x})),y=S.max(e.graph.nodes.map(function(Q){return Q.y})),h=S.max(e.graph.nodes.map(function(Q){return Q.radius})),w=d-l,A=y-f,P=e.options.svgW/(w+1),C=e.options.svgH/(A+1),E=Math.min(P,C,e.options.maxNodeRadius/h)*.8,q=w*E,R=A*E,J=-l*E+(e.options.svgW-q)/2,re=-f*E+(e.options.svgH-R)/2;return{translate:[J,re],scale:E}};e.centerView=function(l=0){var f=le();f!==null&&(k.transition().attr("transform","translate("+f.translate+") scale("+f.scale+")").duration(l),e.zoomer.translate(f.translate),e.zoomer.scale(f.scale))},e.setSize=(l=S.select(s).node().offsetWidth,f=S.select(s).node().offsetHeight)=>{e.options.svgW=l,e.options.svgH=f,m.attr("viewBox","0 0 "+l+" "+f),M.range([0,l]).domain([0,l]),T.range([0,f]).domain([0,f]),e.zoomer.x(M).y(T),e.brusher.x(M).y(T),m.select(".background").attr("width",l).attr("height",f),e.centerView()},e.setOutlineColor=function(l){var f=x.selectAll("g.gnode").select("[node_type=nucleotide]");f.style("fill",l)},e.addCustomColors=function(f){e.customColors=f,e.changeColorScheme("custom")},e.addCustomColorsText=function(l){let f=new lt(l);e.customColors=f.colorsJson,e.changeColorScheme("custom")},e.changeColorScheme=function(l){var f=x.selectAll("[node_type=protein]");f.classed(U.node,!0).attr("r",function(h){return h.radius}),x.selectAll("g.gnode"),x.selectAll("g.gnode").selectAll("circle");var d=x.selectAll("g.gnode").select("[node_type=nucleotide]");if(e.colorScheme=l,l=="sequence"){var y=S.scale.ordinal().range(["#dbdb8d","#98df8a","#ff9896","#aec7e8","#aec7e8"]).domain(["A","C","G","U","T"]);d.style("fill",function(h){return y(h.name)})}else if(l=="structure"){var y=S.scale.category10().domain(["s","m","i","e","t","h","x"]).range(["lightgreen","#ff9896","#dbdb8d","lightsalmon","lightcyan","lightblue","transparent"]);d.style("fill",function(w){return y(w.elemType)})}else if(l=="positions")d.style("fill",function(h){var w=S.scale.linear().range(["#98df8a","#dbdb8d","#ff9896"]).interpolate(S.interpolateLab).domain([1,1+(h.rna.rnaLength-1)/2,h.rna.rnaLength]);return w(h.num)});else if(l=="custom"){if(typeof e.customColors<"u"&&"domain"in e.customColors&&"range"in e.customColors)var y=S.scale.linear().interpolate(S.interpolateLab).domain(e.customColors.domain).range(e.customColors.range);let h=(w,A,P)=>{if(w.hasOwnProperty(A.num)){let C=parseFloat(w[A.num]);return isNaN(C)?w[A.num]:P(C)}else return"white"};d.style("fill",function(w){if(typeof e.customColors>"u"||!e.customColors.hasOwnProperty("colorValues"))return"white";if(e.customColors.colorValues.hasOwnProperty(w.structName)&&e.customColors.colorValues[w.structName].hasOwnProperty(w.num)){let A=e.customColors.colorValues[w.structName];return h(A,w,y)}else if(e.customColors.colorValues.hasOwnProperty("")){let A=e.customColors.colorValues[""];return h(A,w,y)}return"white"})}};let ee=()=>{x.selectAll("[node_type=label]").classed(U.transparent,!e.displayParameters.displayNumbering),x.selectAll("[label_type=label]").classed(U.transparent,!e.displayParameters.displayNumbering),N.selectAll("[link_type=label_link]").classed(U.transparent,!e.displayParameters.displayNumbering),m.selectAll("[node_type=nucleotide]").classed(U.transparent,!e.displayParameters.displayNodeOutline),x.selectAll("[label_type=nucleotide]").classed(U.transparent,!e.displayParameters.displayNodeLabel),m.selectAll("[link_type=real],[link_type=basepair],[link_type=backbone],[link_type=pseudoknot],[link_type=protein_chain],[link_type=chain_chain],[link_type=external]").classed(U.transparent,!e.displayParameters.displayLinks),m.selectAll("[link_type=pseudoknot]").classed(U.transparent,!e.displayParameters.displayPseudoknotLinks),m.selectAll("[link_type=protein_chain]").classed(U.transparent,!e.displayParameters.displayProteinLinks),N.selectAll("[link_type=fake]").classed(U.transparent,!e.options.displayAllLinks),N.selectAll("[link_type=fake_fake]").classed(U.transparent,!e.options.displayAllLinks),m.selectAll("."+U.directionArrow).classed(U.transparent,!e.displayParameters.displayDirectionArrows)},fe=function(l,f){let d=f.rna,y=we.pairtableToDotbracket(d.pairtable),h=d.getPositions("nucleotide"),w=d.seq,A=d.getUids(),P=f.num,C=y,E=w.slice(0,P-1)+l+w.slice(P);console.log("newSequence:",E),console.log("uids:",A),A.splice(P-1,1,K.nice());let q=h;delete e.rnas[d.uid],e.addRNA(C,{sequence:E,positions:q,uids:A,centerView:!1})},ge=function(l,f,d){let y=f.rna,h=we.pairtableToDotbracket(y.pairtable),w=y.getPositions("nucleotide"),A=y.seq,P=y.getUids(),C=f.num+d,E=h.slice(0,C)+"."+h.slice(C),q=A.slice(0,C)+l+A.slice(C);console.log("newSequence:",q),P.splice(C,0,K.nice()),w.splice(C,0,w[C-d-1]);let R=P,J=w;console.log("positions:",w),console.log("new node positions:",J),delete e.rnas[y.uid],e.addRNA(E,{sequence:q,positions:J,uids:R,centerView:!1})},Te=function(l){console.log("deleting...",l);let f=l.rna,d=f.pairtable[l.num];d!=0&&(f.pairtable[l.num]=0,f.pairtable[d]=0);let y=we.pairtableToDotbracket(f.pairtable),h=f.getPositions("nucleotide"),w=f.seq,A=f.getUids(),P=y.slice(0,l.num-1)+y.slice(l.num),C=h.slice(0,l.num-1).concat(h.slice(l.num)),E=w.slice(0,l.num-1)+w.slice(l.num),q=A.slice(0,l.num-1).concat(A.slice(l.num));delete e.rnas[f.uid],e.addRNA(P,{sequence:E,positions:C,uids:q,centerView:!1}),console.log("new dotbracket:",P)},ke=l=>l.uid,Ee=function(l){let f=l.getPositions("nucleotide"),d=l.getPositions("label"),y=l.getUids();l.recalculateElements().elementsToJson().addPseudoknots().addPositions("nucleotide",f).addUids(y).addLabels(1,e.options.labelInterval).addPositions("label",d).reinforceStems().reinforceLoops().updateLinkUids()},_e=function(l){if(l.target.num-l.source.num!=1){console.log("ERROR: non adjacent nodes. Target:",l.target,"Source:",l.source,"Link:",l);return}let f=l.target.rna,d=[];for(let H=0;H<f.links.length;H++){let xe=f.links[H];xe.linkType=="basepair"&&xe.source.num<=l.source.num&&xe.target.num>=l.target.num&&(console.log("crossing basepair",xe),d.push(xe))}console.log("toRemove:",d);for(let H=0;H<d.length;H++)f.pairtable[d[H].source.num]=0,f.pairtable[d[H].target.num]=0,d[H].from=d[H].source.num,d[H].to=d[H].target.num-l.source.num;f.seq;let y=f.seq.slice(0,l.source.num),h=f.seq.slice(l.source.num),w=we.pairtableToDotbracket(f.pairtable),A=w.slice(0,l.source.num),P=w.slice(l.source.num),C=f.getPositions("nucleotide"),E=f.getUids(),q=C.slice(0,l.source.num),R=C.slice(l.source.num),J=E.slice(0,l.source.num),re=E.slice(l.source.num);console.log("positions1:",q),console.log("positions2:",R),delete e.rnas[f.uid];let Q=e.addRNA(A,{sequence:y,positions:q,uids:J}),O=e.addRNA(P,{sequence:h,positions:R,uids:re});for(let H=0;H<d.length;H++)console.log("rna1:",Q),console.log("rna2:",O),console.log("toRemove[i]",d[H]),e.extraLinks.push({source:Q.nodes[d[H].from-1],target:O.nodes[d[H].to-1],value:1,uid:K.nice(),linkType:"intermolecule"}),Z(),e.update();console.log("self.extraLinks:",e.extraLinks)};var Xe=function(l){let f=e.graph.links.indexOf(l);if(console.log("removing link:",f),f>-1){if(l.source.rna==l.target.rna)if(l.linkType=="backbone"){console.log("trying to remove a backbone link",l.source.num,l.target.num),_e(l);return}else{let d=l.source.rna;d.addPseudoknots(),d.pairtable[l.source.num]=0,d.pairtable[l.target.num]=0,Ee(d)}else{let d=e.extraLinks.indexOf(l);e.extraLinks.splice(d,1)}Z()}e.update()};let Ye=function(l){let f=l.target.rna,d=l.source.rna;l.target.num==1&&(f=l.source.rna,d=l.target.rna);let y=we.pairtableToDotbracket(f.pairtable),h=we.pairtableToDotbracket(d.pairtable),w=f.seq,A=d.seq,P=f.getPositions("nucleotide"),C=d.getPositions("nucleotide"),E=y+h,q=w+A,R=P.concat(C),J=[],re={};for(let O=0;O<e.extraLinks.length;O++)console.log("self.extraLinks[i]",e.extraLinks[O]),console.log("rna1:",f),console.log("rna2:",d),e.extraLinks[O].source.rna==f?e.extraLinks[O].target.rna==d||(J.push({source:e.extraLinks[O].target,target:e.extraLinks[O].source.num}),re[e.extraLinks[O].uid]=!0):e.extraLinks[O].source.rna==d&&(e.extraLinks[O].target.rna==f||(J.push({source:e.extraLinks[O].target,target:e.extraLinks[O].source.num+y.length}),re[e.extraLinks[O].uid]=!0)),e.extraLinks[O].target.rna==f?e.extraLinks[O].source.rna==d||(J.push({source:e.extraLinks[O].source,target:e.extraLinks[O].target.num}),re[e.extraLinks[O].uid]=!0):e.extraLinks[O].target.rna==d&&e.extraLinks[O].source.rna==f&&(J.push({source:e.extraLinks[O].source,target:e.extraLinks[O].target.num+y.length}),re[e.extraLinks[O].uid]=!0);e.extraLinks=e.extraLinks.filter(O=>!(O.uid in re)),delete e.rnas[f.uid],delete e.rnas[d.uid];let Q=null;e.options.animation?Q=e.addRNA(E,{sequence:q,positions:R,centerView:!1}):Q=e.addRNA(E,{sequence:q,centerView:!1});for(let O=0;O<J.length;O++)e.extraLinks.push({source:J[O].source,target:Q.nodes[J[O].target-1],value:1,uid:K.nice(),linkType:"intermolecule"});Z(),e.update(),console.log("self.extraLinks:",e.extraLinks)},Pe=function(l,f){console.log("nodeMouseup");let d=!0;if(t){if(a=l,a.nodeType=="middle"||t.nodeType=="middle"||a.nodeType=="label"||t.nodeType=="label")return;if(a==t){u();return}let y={source:t,target:a,linkType:"basepair",value:1,uid:K.nice()};for(let h=0;h<e.graph.links.length;h++)if((e.graph.links[h].source==t||e.graph.links[h].target==t||e.graph.links[h].source==a||e.graph.links[h].target==a)&&(e.graph.links[h].linkType=="basepair"||e.graph.links[h].linkType=="pseudoknot"||e.graph.links[h].linkType=="intermolecule")&&(console.log("no basepair possible"),d=!1),(e.graph.links[h].source==a&&e.graph.links[h].target==t||e.graph.links[h].source==t&&e.graph.links[h].target==a)&&e.graph.links[h].linkType=="backbone")return;if(y.source.rna!=y.target.rna)if(y.source.num==1&&y.target.num==y.target.rna.rnaLength||y.target.num==1&&y.source.num==y.source.rna.rnaLength){let h=[{title:"Backbone Link",action:function(A,P,C){i=!1,console.log("Item #1 clicked!"),console.log("The data for this circle is: "+P),L.attr("class",U.transparent),Ye(y)},disabled:!1},{title:"Basepair Link",action:function(A,P,C){i=!1,console.log("You have clicked the second item!"),console.log("The data for this circle is: "+P),L.attr("class",U.transparent),e.addLink(y)}}];i=!0;let w=Ie(h);console.log("newLinkMenu"),w.apply(this,[l,f,!0,function(){L.attr("class",U.transparent)}])}else d&&e.addLink(y);else d&&e.addLink(y)}},Ce=function(l){console.log("nodeMousedown"),!l.selected&&!g&&B(),p||(g?I(l):z(l)),p&&e.options.editable&&(t=l,L.attr("class",U.dragLine).attr("x1",t.x).attr("y1",t.y).attr("x2",t.x).attr("y2",t.y),S.event.stopPropagation())},Oe=l=>{if(p){var f={fake:!0,fake_fake:!0,label_link:!0};console.log("d.linkType:",l.linkType),!(l.linkType in f)&&Xe(l)}};e.toJSON=function(){var f={rnas:e.rnas,extraLinks:e.extraLinks},d=JSON.stringify(f,function(y,h){if(y!="rna")return h},"	");return d},e.fromJSON=function(l){var f,d;try{var y=JSON.parse(l);f=y.rnas,d=y.extraLinks}catch(w){throw w}for(var h in f)f[h].type=="rna"?(r=new ze,r.seq=f[h].seq,r.dotbracket=f[h].dotbracket,r.circular=f[h].circular,r.pairtable=f[h].pairtable,r.uid=f[h].uid,r.structName=f[h].structName,r.nodes=f[h].nodes,r.links=f[h].links,r.rnaLength=f[h].rnaLength,r.elements=f[h].elements,r.nucsToNodes=f[h].nucsToNodes,r.pseudoknotPairs=f[h].pseudoknotPairs):(r=new ProteinGraph,r.size=f[h].size,r.nodes=f[h].nodes,r.uid=f[h].uid),e.addRNAJSON(r,!1);d.forEach(function(w){e.extraLinks.push(w)}),Z(),e.update()},e.addRNA=function(l,f={}){let d=ve(l,f);if("extraLinks"in f){let y=e.addExternalLinks(d,f.extraLinks);e.extraLinks=e.extraLinks.concat(y)}return"centerPos"in f?e.addRNAJSON(d,{centerPos:f.centerPos,centerView:!1}):"avoidOthers"in f?e.addRNAJSON(d,{avoidOthers:f.avoidOthers}):e.addRNAJSON(d,{centerView:f.centerView}),d},e.addRNAJSON=function(l,{avoidOthers:f=!1,centerPos:d=null,centerView:y=!0}){var h,w;if(d!=null){let A=0,P=0,C=0;l.nodes.forEach(function(E){A+=E.x,P+=E.y,C+=1}),C>0&&l.nodes.forEach(function(E){E.x=E.x+d[0]-A/C,E.y=E.y+d[1]-P/C,E.px=E.x,E.py=E.y})}return f&&(e.graph.nodes.length>0?h=S.max(e.graph.nodes.map(function(A){return A.x})):h=0,w=S.min(l.nodes.map(function(A){return A.x})),l.nodes.forEach(function(A){A.x+=h-w+20,A.px+=h-w})),l.nodes.forEach(function(A){A.rna=l}),e.rnas[l.uid]=l,Z(),e.update(),y&&e.centerView(),l},e.addNodes=function(f){f.links.forEach(function(d){typeof d.source=="number"&&(d.source=f.nodes[d.source]),typeof d.target=="number"&&(d.target=f.nodes[d.target])}),e.graph.nodes.length>0?(maxX=S.max(e.graph.nodes.map(function(d){return d.x})),maxY=S.max(e.graph.nodes.map(function(d){return d.y}))):(maxX=0,maxY=0),f.nodes.forEach(function(d){d.rna.uid in e.rnas||(e.rnas[d.rna.uid]=d.rna),d.x+=maxX,d.px+=maxX}),r=new ze("",""),r.nodes=f.nodes,r.links=f.links,Z(),e.update(),e.centerView()},e.clearNodes=()=>{e.graph.nodes=[],e.graph.links=[],e.rnas={},e.extraLinks=[],e.update()},e.addLink=function(l){if(console.log("adding new link"),l.source.rna==l.target.rna){let f=l.source.rna;f.pairtable[l.source.num]=l.target.num,f.pairtable[l.target.num]=l.source.num,Ee(f)}else console.log("intermolecule"),l.linkType="intermolecule",e.extraLinks.push(l);Z(),e.update()},e.addExternalLinks=function(l,f){let d=[];for(let y=0;y<f.length;y++){let h={linkType:"external",value:1,uid:K.nice(),source:null,target:null};if(Object.prototype.toString.call(f[y][0])==="[object Array]"){for(let w=0;w<l.nodes.length;w++)if("nucs"in l.nodes[w]&&l.nodes[w].nucs.equals(f[y][0])){h.source=l.nodes[w];break}}else for(let w=0;w<l.nodes.length;w++)l.nodes[w].num==f[y][0]&&(h.source=l.nodes[w]);if(Object.prototype.toString.call(f[y][1])==="[object Array]")for(let w=0;w<l.nodes.length;w++)"nucs"in l.nodes[w]&&l.nodes[w].nucs.equals(f[y][1])&&(h.target=l.nodes[w]);else for(let w=0;w<l.nodes.length;w++)l.nodes[w].num==f[y][1]&&(h.target=l.nodes[w]);if(h.source==null||h.target==null){console.log("ERROR: source or target of new link not found:",h,f[y]);continue}d.push(h)}return d},e.getStructuresDotBracket=function(){console.log("self.rnas:",e.rnas);let l=[],f=1,d={},y=[],h=[];for(let A in e.rnas){let P=e.rnas[A];for(let C=0;C<P.nodes.length;C++){let E=P.nodes[C];E.nodeType=="nucleotide"&&(console.log("node:",E),d[E.uid]=f,f+=1,l.push(E.name))}y.push(f)}h=[f-1];for(let A=0;A<f;A++)h.push(0);for(let A in e.rnas){let P=e.rnas[A];for(let C=0;C<P.links.length;C++){let E=P.links[C];if(E.linkType!="basepair")continue;let q=d[E.source.uid],R=d[E.target.uid];h[q]=R,h[R]=q}}for(let A=0;A<e.extraLinks.length;A++){let P=e.extraLinks[A],C=d[P.source.uid],E=d[P.target.uid];h[C]=E,h[E]=C}let w=we.pairtableToDotbracket(h).split("");for(let A=0;A<y.length-1;A++)console.log("breaks[i]:",y[A]),l.splice(y[A]+A-1,0,"&"),w.splice(y[A]+A-1,0,"&");return console.log("sequence:",l,l.join("")),console.log("structure:",w,w.join("")),[l.join(""),w.join("")]},e.startAnimation=function(){e.options.animation=!0,k.selectAll("g.gnode").call($),e.force.start()},e.stopAnimation=function(){e.options.animation=!1,k.selectAll("g.gnode").on("mousedown.drag",null),e.force.stop()},e.resumeForce=function(){e.options.animation&&e.force.resume()},e.setFriction=function(l){e.force.friction(l),e.resumeForce()},e.setCharge=function(l){e.force.charge(l),e.resumeForce()},e.setGravity=function(l){e.force.gravity(l),e.resumeForce()},e.setPseudoknotStrength=function(l){e.linkStrengths.pseudoknot=l,e.update()},e.displayNumbering=function(l){e.displayParameters.displayNumbering=l,ee()},e.displayNodeOutline=function(l){e.displayParameters.displayNodeOutline=l,ee()},e.displayNodeLabel=function(l){e.displayParameters.displayNodeLabel=l,ee()},e.displayLinks=function(l){e.displayParameters.displayLinks=l,ee()},e.displayPseudoknotLinks=function(l){e.displayParameters.displayPseudoknotLinks=l,ee()},e.displayProteinLinks=function(l){e.displayParameters.displayProteinLinks=l,ee()},e.displayDirectionArrows=function(l){e.displayParameters.displayDirectionArrows=l,ee()}}function ft(s={}){var n={width:300,height:300,nucleotideRadius:5,rnaEdgePadding:1,labelInterval:10,showNucleotideLabels:!0,startNucleotideNumber:1,bundleExternalLinks:!1,rnaLayout:"simple",namePosition:"0 0"},n=Object.assign(n,s),e,o;function t(m,b){let k=d3.extent(m),N=d3.extent(b);k[0]-=n.nucleotideRadius+n.rnaEdgePadding,N[0]-=n.nucleotideRadius+n.rnaEdgePadding,k[1]+=n.nucleotideRadius+n.rnaEdgePadding,N[1]+=n.nucleotideRadius+n.rnaEdgePadding;var x=k[1]-k[0],L=N[1]-N[0],M=x-n.width,T=L-n.height;function v(I,z,B){var X=(I.range()[1]-I.range()[0])/(I.domain()[1]-I.domain()[0]),j=(z[1]-z[0])*X,Y=(B[1]-B[0]-j)/2;return{scaleFactor:X,scale:d3.scale.linear().domain(z).range([B[0]+Y,B[1]-Y])}}var _;return M>T?(e=d3.scale.linear().domain(k).range([0,n.width]),_=v(e,N,[0,n.height]),o=_.scale):(o=d3.scale.linear().domain(N).range([0,n.height]),_=v(o,k,[0,n.width]),e=_.scale),e.range()[0]-e.domain()[0],o.range()[0]-o.domain()[0],"translate("+-(e.domain()[0]*_.scaleFactor-e.range()[0])+","+-(o.domain()[0]*_.scaleFactor-o.range()[0])+")scale("+_.scaleFactor+")"}function a(m,b){var k=m.selectAll(".gnode").data(b).enter().append("svg:g").classed("gnode",!0).attr("transform",function(N){return"translate("+N.x+","+N.y+")"});k.append("svg:circle").classed(U.node,!0).attr("node_type","nucleotide").attr("base_type",N=>{if(N.name)return N.name.toLowerCase()}).attr("r",n.nucleotideRadius),n.showNucleotideLabels&&k.append("svg:text").text(function(N){return N.name}).classed(U.nodeLabel,!0).append("svg:title").text(function(N){return N.struct_name+":"+N.num})}function i(m,b){var k=m.selectAll().data(b).enter().append("svg:g").classed("gnode",!0).attr("transform",function(N){return"translate("+N.x+","+N.y+")"});k.append("svg:circle").classed(U.node,!0).attr("node_type","label").attr("r",n.nucleotideRadius),k.append("svg:text").classed(U.nodeLabel,!0).text(function(N){return N.name})}function u(m,b){let k=m.append("svg:text").classed(U.plotLabel,!0).text(b),N=n.namePosition.split(" ",2),x=[],L=k.node().getBBox(),M=[L.width,L.height],T=[n.width,n.height];for(let v in[0,1])switch(N[v]){case"0":x[v]=M[v]/2;break;case"1":x[v]=T[v]-M[v]/2;break;case"0.5":x[v]=T[v]/2;break}k.attr("x",x[0]).attr("y",x[1])}function c(m,b){var k={},N=[];b=b.filter(function(_){return _.linkType=="correct"||_.linkType=="incorrect"||_.linkType=="extra"}),m.selectAll("[link-type=extra]").remove();for(var x=0;x<b.length;x++)b[x].source===null||b[x].target===null||(k[b[x].source.uid]=b[x].source,k[b[x].target.uid]=b[x].target,N.push({source:b[x].source.uid,target:b[x].target.uid,linkType:b[x].linkType,extraLinkType:b[x].extraLinkType}));for(var L=d3.ForceEdgeBundling().nodes(k).edges(N).compatibility_threshold(.8).step_size(.2),M=L(),T=d3.svg.line().x(function(_){return _.x}).y(function(_){return _.y}).interpolate("linear"),x=0;x<M.length;x++){var v=M[x];m.append("path").attr("d",T(v)).style("fill","none").attr("link-type",function(I){return N[x].linkType}).attr("extra-link-type",function(I){return N[x].extraLinkType}).style("stroke-opacity",.4)}}function p(m,b){b=b.filter(function(k){return k.source!==null&&k.target!==null}),m.selectAll(".link").data(b).enter().append("svg:line").attr("x1",function(k){return k.source.x}).attr("x2",function(k){return k.target.x}).attr("y1",function(k){return k.source.y}).attr("y2",function(k){return k.target.y}).attr("link-type",function(k){return k.linkType}).attr("extra-link-type",function(k){return k.extraLinkType}).classed("link",!0).classed(U.link,!0)}function g(m){m.each(function(b){let k=d3.select(this).append("g").classed(U.plot,!0),N=new ze(b.sequence,b.structure,b.name,n.startNucleotideNumber).recalculateElements().elementsToJson().addName(b.name);b.rnaGraph=N;let x=[];if(n.rnaLayout==="naview")for(var L=new ne,M=L.naview_xy_coordinates(N.pairtable),T=0;T<M.nbase;T++)x.push([M.x[T],M.y[T]]);else x=ut(N.pairtable);N.addPositions("nucleotide",x).addLabels(n.startNucleotideNumber,n.labelInterval);let v=t(N.nodes.map(function(B){return B.x}),N.nodes.map(function(B){return B.y}));k.attr("transform",v);let _=N.nodes.filter(function(B){return B.nodeType=="nucleotide"}),I=N.nodes.filter(function(B){return B.nodeType=="label"}),z=N.links;p(k,z),a(k,_),i(k,I),u(d3.select(this),b.name),n.bundleExternalLinks&&c(k,z)})}return g.width=function(m){return arguments.length?(n.width=m,g):n.width},g.height=function(m){return arguments.length?(n.height=m,g):n.height},g.showNucleotideLabels=function(m){return arguments.length?(n.showNucleotideLabels=m,g):n.showNucleotideLabels},g.rnaEdgePadding=function(m){return arguments.length?(n.rnaEdgePadding=m,g):n.rnaEdgePadding},g.nucleotideRadius=function(m){return arguments.length?(n.nucleotideRadius=m,g):n.nucleotideRadius},g.labelInterval=function(m){return arguments.length?(n.labelInterval=m,g):n.labelInterval},g.showNucleotideLabels=function(m){return arguments.length?(n.showNucleotideLabels=m,g):n.showNucleotideLabels},g.startNucleotideNumber=function(m){return arguments.length?(n.startNucleotideNumber=m,g):n.startNucleotideNumber},g.bundleExternalLinks=function(m){return arguments.length?(n.bundleExternalLinks=m,g):n.bundleExternalLinks},g.rnaLayout=function(m){return arguments.length?(n.rnaLayout=m,g):n.rnaLayout},g.namePosition=function(m){return arguments.length?(n.namePosition=m,g):n.namePosition},g}function Dt(s={}){var n={width:300,height:300,nucleotideRadius:5,rnaEdgePadding:1,labelInterval:10,showNucleotideLabels:!0,startNucleotideNumber:1,bundleExternalLinks:!1,rnaLayout:"simple",namePosition:"0 0"},n=Object.assign(n,s);function e(t){t.each(function(a){d3.select(this).attr("transform",function(u){return"translate("+u.x+","+u.y+")"}).append("rect").attr("fill","transparent").attr("width",function(u){return Math.max(0,u.dx)}).attr("height",function(u){return Math.max(0,u.dy)});var i=ft(n).width(Math.max(0,a.dx)).height(Math.max(0,a.dy));"structure"in a&&d3.select(this).call(i)})}var o=function(t){t.each(function(a){console.log("data:",a);var i=d3.layout.treemap().size([n.width,n.height]).sticky(!1).value(function(c){return c.size}),u=d3.select(this).append("g").classed("rnatreemap",!0);u.datum(a).selectAll(".treemapnode").data(i.nodes).enter().append("g").classed("treemapnode",!0).call(e)})};return o.width=function(t){return arguments.length?(n.width=t,o):n.width},o.height=function(t){return arguments.length?(n.height=t,o):n.height},o.showNucleotideLabels=function(t){return arguments.length?(n.showNucleotideLabels=t,o):n.showNucleotideLabels},o.rnaEdgePadding=function(t){return arguments.length?(n.rnaEdgePadding=t,o):n.rnaEdgePadding},o.nucleotideRadius=function(t){return arguments.length?(n.nucleotideRadius=t,o):n.nucleotideRadius},o.labelInterval=function(t){return arguments.length?(n.labelInterval=t,o):n.labelInterval},o.showNucleotideLabels=function(t){return arguments.length?(n.showNucleotideLabels=t,o):n.showNucleotideLabels},o.startNucleotideNumber=function(t){return arguments.length?(n.startNucleotideNumber=t,o):n.startNucleotideNumber},o.bundleExternalLinks=function(t){return arguments.length?(n.bundleExternalLinks=t,o):n.bundleExternalLinks},o.rnaLayout=function(t){return arguments.length?(n.rnaLayout=t,o):n.rnaLayout},o.namePosition=function(t){return arguments.length?(n.namePosition=t,o):n.namePosition},o.zoom=function(t){return arguments.length?(n.zoom=t,o):n.zoom},o}me.ColorScheme=lt,me.FornaContainer=qt,me.RNAUtilities=at,me.rnaPlot=ft,me.rnaTreemap=Dt,Object.defineProperty(me,Symbol.toStringTag,{value:"Module"})}));
//# sourceMappingURL=fornac.js.map
